# configs/base.yaml
# AItrader 配置文件 - 所有参数的完整定义
# 此文件包含所有配置项的默认值，是配置的唯一来源
# 版本: 3.0 (TradingAgents v3.6 完整数据覆盖)

# =============================================================================
# 交易配置
# =============================================================================
trading:
  # 交易对配置
  instrument_id: "BTCUSDT-PERP.BINANCE"
  timeframe: "15m"                # 时间周期 (1m/5m/15m/1h/4h/1d)
  bar_type: "BTCUSDT-PERP.BINANCE-15-MINUTE-LAST-EXTERNAL"

  # 数据获取
  historical_bars_limit: 200      # 启动时获取的历史K线数量

# =============================================================================
# 交易逻辑常量 (来自 strategy/trading_logic.py)
# =============================================================================
trading_logic:
  # Binance 交易限制
  min_notional_usdt: 100.0        # Binance 最低名义价值 (不建议修改)
  min_notional_safety_margin: 1.01  # 安全边际 1%

  # 止损止盈默认值
  min_sl_distance_pct: 0.01       # 最小止损距离 1%
  min_tp_distance_pct: 0.005      # 最小止盈距离 0.5%
  default_sl_pct: 0.02            # 默认止损 2%
  default_tp_pct: 0.03            # 默认止盈 3%

  # 按信心级别的止盈配置
  tp_pct_by_confidence:
    high: 0.03                    # 高信心: 3%
    medium: 0.02                  # 中等信心: 2%
    low: 0.01                     # 低信心: 1%

  # 仓位精度调整
  quantity_adjustment_step: 0.001 # BTC 仓位调整步长

# =============================================================================
# 资金配置
# =============================================================================
capital:
  equity: 1000                    # 备用资金值 (当无法获取真实余额时使用)
  leverage: 5                     # 杠杆倍数 (建议 3-10)
  use_real_balance_as_equity: true  # 自动从 Binance 获取真实余额

# =============================================================================
# 仓位管理
# =============================================================================
position:
  base_usdt_amount: 100           # 基础仓位 USDT (Binance 最低 $100)
  high_confidence_multiplier: 1.5   # 高信心仓位乘数
  medium_confidence_multiplier: 1.0 # 中等信心仓位乘数
  low_confidence_multiplier: 0.5    # 低信心仓位乘数
  max_position_ratio: 0.30        # 最大仓位比例 (占 equity 的比例)
  trend_strength_multiplier: 1.2  # 趋势强度乘数
  min_trade_amount: 0.001         # 最小交易量 (BTC)
  adjustment_threshold: 0.001     # 仓位调整阈值 (BTC)

# =============================================================================
# 技术指标
# =============================================================================
indicators:
  # SMA 配置
  # 注意: 200 是 MTF 趋势层 (1D) 需要的，用于 RISK_ON/OFF 判断
  sma_periods: [5, 20, 50, 200]

  # EMA 配置
  ema_periods: [12, 26]

  # RSI 配置
  rsi_period: 14

  # MACD 配置
  macd_fast: 12
  macd_slow: 26
  macd_signal: 9

  # 布林带配置
  bb_period: 20
  bb_std: 2.0

  # 其他
  volume_ma_period: 20
  support_resistance_lookback: 20

# =============================================================================
# AI 配置
# =============================================================================
ai:
  # DeepSeek 配置
  deepseek:
    api_key: ""                   # 从 .env 读取 (DEEPSEEK_API_KEY)
    model: "deepseek-chat"
    temperature: 0.3              # 注意: main_live.py 曾硬编码为 0.1
    max_retries: 2
    retry_delay: 1.0              # API 重试延迟
    base_url: "https://api.deepseek.com"

  # 多代理辩论配置
  multi_agent:
    debate_rounds: 2              # 辩论轮数 (1-3)
    retry_delay: 1.0              # 重试延迟 (秒)
    json_parse_max_retries: 2     # JSON 解析重试

  # 信号处理
  signal:
    history_count: 30             # 信号历史队列大小 (原 maxlen=30)
    skip_on_divergence: true      # [LEGACY] AI 分歧时跳过交易
    use_confidence_fusion: true   # [LEGACY] 不再使用

# =============================================================================
# 情绪数据
# =============================================================================
sentiment:
  enabled: true
  provider: "binance"             # binance / cryptooracle (已弃用)
  lookback_hours: 4
  timeframe: "15m"
  weight: 0.30                    # 决策权重
  timeout: 10                     # 请求超时 (秒)
  update_interval_minutes: 15     # 更新间隔 (分钟)

# =============================================================================
# 风险管理
# =============================================================================
risk:
  # 信心阈值
  min_confidence_to_trade: "MEDIUM"  # LOW / MEDIUM / HIGH
  allow_reversals: true
  require_high_confidence_for_reversal: false
  max_consecutive_same_signal: 5

  # RSI 阈值 - 注意: main_live.py 曾硬编码为 75/25
  rsi_extreme_threshold_upper: 70.0  # RSI 超买阈值
  rsi_extreme_threshold_lower: 30.0  # RSI 超卖阈值
  rsi_extreme_multiplier: 0.7

  # ===== v3.7: BB 位置硬性检查 (Support/Resistance Risk Control) =====
  bb_block_enabled: true                # 启用 BB 位置硬性检查
  bb_block_threshold_pct: 2.0           # 距离 BB 边界 < 2% 时阻止交易
  bb_high_confidence_override: false    # 高信心时允许突破 (默认 false，保守)

  # 止损止盈
  stop_loss:
    enabled: true
    use_support_resistance: true
    buffer_pct: 0.001             # 缓冲 0.1%

  take_profit:
    high_confidence_pct: 0.03     # 高信心: 3%
    medium_confidence_pct: 0.02   # 中等信心: 2%
    low_confidence_pct: 0.01      # 低信心: 1%

  # 移动止损
  trailing_stop:
    enabled: true
    activation_pct: 0.01          # 盈利 1% 后启动
    distance_pct: 0.005           # 跟踪距离 0.5%
    update_threshold_pct: 0.002   # 更新阈值 0.2%

  # OCO 订单
  oco:
    enabled: true                 # 控制孤儿订单清理

  # Partial Take Profit (部分止盈) - 功能未实现
  partial_tp:
    enabled: false  # 未实现 - 请保持 false
    levels:  # 止盈级别配置 (保留用于未来实现)
      - {profit_pct: 0.02, position_pct: 0.5}  # 盈利2%时平50%仓位
      - {profit_pct: 0.04, position_pct: 0.5}  # 盈利4%时平剩余50%仓位

# =============================================================================
# 网络配置
# =============================================================================
network:
  # 合约发现重试
  instrument_discovery:
    max_retries: 60               # 最大重试次数
    retry_interval: 1.0           # 重试间隔 (秒)

  # Binance API
  binance:
    recv_window: 5000             # 接收窗口 (ms)
    balance_cache_ttl: 5.0        # 余额缓存时间 (秒)
    api_timeout: 10               # API 请求超时 (秒)

  # K线数据持久化
  bar_persistence:
    max_limit: 1500               # Binance K线最大获取数量
    timeout: 10                   # 请求超时 (秒)

  # OCO 订单管理 (Redis)
  oco_manager:
    socket_timeout: 5             # Redis socket 超时 (秒)
    socket_connect_timeout: 5     # Redis 连接超时 (秒)

  # Telegram
  telegram:
    startup_delay: 5              # 启动延迟 (秒)
    polling_max_retries: 3        # 轮询最大重试次数
    polling_base_delay: 10        # 轮询重试基础延迟 (秒)
    message_timeout: 30           # 消息发送超时 (秒)

# =============================================================================
# Telegram 通知
# =============================================================================
telegram:
  enabled: true
  # bot_token 和 chat_id 从 .env 读取 (TELEGRAM_BOT_TOKEN, TELEGRAM_CHAT_ID)
  bot_token: ""
  chat_id: ""

  # 通知类型
  notify:
    signals: true
    fills: true
    positions: true
    errors: true
    heartbeat: true           # v2.1: 每次 on_timer 运行发送心跳状态 (测试阶段推荐开启)

# =============================================================================
# 执行配置
# =============================================================================
execution:
  order_type: "MARKET"
  time_in_force: "GTC"
  reduce_only_for_closes: true
  position_adjustment_threshold: 0.001  # Min 0.001 BTC difference to adjust

  # NautilusTrader 执行引擎配置 (原 main_live.py 硬编码)
  engine:
    reconciliation: true                  # 仓位对账
    inflight_check_interval_ms: 5000      # 在途订单检查间隔 (ms)
    filter_position_reports: true         # 过滤持仓报告
    filter_unclaimed_external_orders: true # 过滤未认领的外部订单

# =============================================================================
# 定时器配置
# =============================================================================
timing:
  timer_interval_sec: 900         # 分析间隔 (秒)，15分钟

# =============================================================================
# 日志配置
# =============================================================================
logging:
  level: "INFO"
  to_file: true
  file: "logs/deepseek_strategy.log"
  log_signals: true
  log_positions: true
  log_ai_responses: true

# =============================================================================
# 诊断工具阈值 (diagnose_realtime.py 使用)
# =============================================================================
diagnostics:
  # 布林带阈值
  bb_overbought_threshold: 80       # BB% 超买阈值
  bb_oversold_threshold: 20         # BB% 超卖阈值

  # 多空比阈值
  ls_ratio_extreme_bullish: 2.0     # 极度看多阈值
  ls_ratio_bullish: 1.5             # 看多阈值
  ls_ratio_extreme_bearish: 0.5     # 极度看空阈值
  ls_ratio_bearish: 0.7             # 看空阈值

  # MACD 阈值
  macd_strong_signal_threshold: 50  # 强信号阈值

  # 成交量阈值
  volume_spike_multiplier: 2.0      # 成交量突增倍数

# =============================================================================
# 运行时控制 (从环境变量读取)
# =============================================================================
runtime:
  test_mode: false      # 测试模式 (从 TEST_MODE 环境变量读取)
  auto_confirm: false   # 自动确认 (从 AUTO_CONFIRM 环境变量读取)

# =============================================================================
# Binance API 配置 (敏感信息从 .env 读取)
# =============================================================================
binance:
  # api_key 和 api_secret 从 .env 读取 (BINANCE_API_KEY, BINANCE_API_SECRET)
  # testnet_api_key 和 testnet_api_secret 从 .env 读取 (可选)
  # 注意: 以下字段会被 ConfigManager 从环境变量动态填充
  api_key: ""
  api_secret: ""
  testnet_api_key: ""
  testnet_api_secret: ""

# =============================================================================
# 多时间框架配置 (Multi-Timeframe Framework) v3.2
# =============================================================================
multi_timeframe:
  enabled: true                       # 启用三层 MTF 框架 (1D/4H/15M)

  # ---------------------------------------------------------------------------
  # 趋势层配置 (1D) - 提供趋势数据给 AI 分析
  # v3.3: 移除本地过滤逻辑，所有决策交由 AI
  # ---------------------------------------------------------------------------
  trend_layer:
    timeframe: "1d"
    sma_period: 200                   # SMA_200 判断长期趋势 (数据给 AI)
    cache_ttl_hours: 4                # 趋势状态缓存时间

  # ---------------------------------------------------------------------------
  # 决策层配置 (4H) - Bull/Bear 辩论决定方向
  # ---------------------------------------------------------------------------
  decision_layer:
    timeframe: "4h"
    debate_rounds: 2                  # TradingAgents 辩论轮数
    include_trend_context: true       # 在辩论中包含趋势层信息
    indicators:
      sma_periods: [20, 50]
      rsi_period: 14
      macd_fast: 12
      macd_slow: 26
      bb_period: 20
      bb_std: 2.0

  # ---------------------------------------------------------------------------
  # 执行层配置 (5M / 15M) - 提供执行层数据给 AI
  # v3.3: 移除本地 RSI 过滤，所有入场决策交由 AI
  # ---------------------------------------------------------------------------
  execution_layer:
    default_timeframe: "15m"          # 默认执行周期
    high_volatility_timeframe: "5m"   # 高波动时使用 5M
    indicators:
      sma_periods: [5, 20]
      ema_periods: [10]
      rsi_period: 14
      support_resistance_lookback: 20

  # ---------------------------------------------------------------------------
  # 初始化配置 (request_bars 预取)
  # ---------------------------------------------------------------------------
  initialization:
    trend_min_bars: 220               # 趋势层最少 bar 数量 (SMA_200 + 缓冲)
    decision_min_bars: 60             # 决策层最少 bar 数量 (SMA_50 + 缓冲)
    execution_min_bars: 40            # 执行层最少 bar 数量
    request_timeout_sec: 300          # 请求超时 (秒)
    max_retry_attempts: 3             # 最大重试次数

# =============================================================================
# Binance 衍生品配置 (v3.7)
# =============================================================================
binance_derivatives:
  trend_calculation:
    threshold_pct: 5.0                # 趋势判断阈值 (% 变化)

# =============================================================================
# 订单流数据配置 (Order Flow) v3.2
# =============================================================================
order_flow:
  enabled: true                       # 启用订单流数据增强

  # ---------------------------------------------------------------------------
  # Binance K线完整字段
  # ---------------------------------------------------------------------------
  binance:
    use_taker_data: true              # 使用 taker_buy_volume (列[9])
    use_quote_volume: true            # 使用 quote_volume (列[7])
    use_trades_count: true            # 使用 trades_count (列[8])
    bars_for_analysis: 10             # 分析最近 N 根 K线

  # ---------------------------------------------------------------------------
  # Coinalyze 衍生品数据 (需要 API Key)
  # ---------------------------------------------------------------------------
  coinalyze:
    enabled: true                     # 启用 Coinalyze 数据
    api_key: ""                       # 从 ~/.env.aitrader 的 COINALYZE_API_KEY 读取
    timeout: 10                       # API 请求超时 (秒)
    symbol: "BTCUSDT_PERP.A"          # Coinalyze Symbol 格式 (A=Binance)
    endpoints:
      open_interest: true
      liquidations: true
      funding_rate: true
    # 降级策略: API 失败时使用默认值
    fallback_enabled: true
    fallback_oi_usd: 0
    fallback_funding_rate: 0

    # ===== v3.7: Funding Rate 数据源配置 =====
    # ⚠️ 重要: 资金费率统一使用 Binance 8 小时资金费率
    # Binance 合约每 8 小时结算一次 (00:00, 08:00, 16:00 UTC)
    # Coinalyze 数据是多交易所聚合值，可能与 Binance 实际费率差异较大
    funding_rate:
      prefer_binance_when_divergent: true   # 差异大时使用 Binance
      max_divergence_ratio: 10.0            # 差异超过 10x 视为异常
      always_use_binance: true              # ✅ 始终使用 Binance 8h 资金费率 (v3.8 默认)

  # ---------------------------------------------------------------------------
  # 买卖比阈值
  # ---------------------------------------------------------------------------
  buy_ratio:
    bullish_threshold: 0.55           # >55% 视为多头主导
    bearish_threshold: 0.45           # <45% 视为空头主导
    trend_threshold: 0.01             # 趋势判断阈值 (前5根 vs 后5根差值)

  # ---------------------------------------------------------------------------
  # Prompt 配置
  # ---------------------------------------------------------------------------
  prompt:
    version: "optimized"              # "optimized" (~600 tokens) 或 "full" (~1800 tokens)
    include_interpretation_guide: true # 在 Prompt 中包含解读指南
    weights:                          # 各数据权重 (供 AI 参考)
      order_flow: 0.30
      technical: 0.25
      derivatives: 0.25
      sentiment: 0.20

# =============================================================================
# 订单簿深度配置 (Order Book Depth) v2.0 - v3.7 新增
# =============================================================================
order_book:
  enabled: true                       # 启用订单簿数据 (v3.7 已测试通过)

  # ---------------------------------------------------------------------------
  # API 配置
  # ---------------------------------------------------------------------------
  api:
    endpoint: "/fapi/v1/depth"
    limit: 100                        # 深度档位数 (5, 10, 20, 50, 100, 500, 1000)
    timeout: 10                       # 请求超时 (秒)
    max_retries: 2                    # 最大重试次数
    retry_delay: 1.0                  # 重试延迟 (秒)

  # ---------------------------------------------------------------------------
  # 处理配置 (v2.0 更新)
  # ---------------------------------------------------------------------------
  processing:
    price_band_pct: 0.5               # 价格带宽度百分比

    # v2.0: 加权 OBI 可配置化
    weighted_obi:
      base_decay: 0.8                 # 基础衰减因子
      adaptive: true                  # 启用自适应衰减 (基于波动率)
      volatility_factor: 0.1          # 波动率影响因子
      min_decay: 0.5                  # 最小衰减 (高波动时)
      max_decay: 0.95                 # 最大衰减 (低波动时)

    # v2.0: 动态异常阈值
    anomaly_detection:
      base_threshold: 3.0             # 基础阈值 (倍数)
      dynamic: true                   # 启用动态调整
      min_threshold: 2.0              # 最小阈值
      max_threshold: 5.0              # 最大阈值

    # 滑点估算
    slippage_amounts:
      - 0.1                           # 0.1 BTC
      - 0.5                           # 0.5 BTC
      - 1.0                           # 1.0 BTC

    # v2.0: 历史缓存 (用于变化率计算)
    history:
      size: 10                        # 缓存最近 N 次快照
      min_samples_for_trend: 3        # 计算趋势需要的最小样本数

  # ---------------------------------------------------------------------------
  # 缓存配置
  # ---------------------------------------------------------------------------
  cache:
    enabled: true                     # 启用缓存
    ttl_seconds: 5                    # 缓存生存时间

  # ---------------------------------------------------------------------------
  # v2.0: 降级配置 (优化)
  # ---------------------------------------------------------------------------
  fallback:
    enabled: true
    # 注意: 不再使用 default_obi = 0.0
    # 而是返回明确的 NO_DATA 状态
    return_no_data_status: true       # 返回 NO_DATA 而非中性值
    default_spread_pct: 0.05          # 仅在格式化时使用
