# 数据源矩阵 (Data Sources Matrix)

> 文档版本: v3.0
> 更新日期: 2026-01-31
> 适用版本: AItrader v3.6+

## 概述

本文档列出所有可从 Binance 和 Coinalyze 获取的数据字段，按时间周期组成矩阵，标明采用状态和建议。

### 系统架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         数据处理架构 v3.0                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐               │
│  │   Binance    │    │  Coinalyze   │    │  本地计算     │               │
│  │   (14 APIs)  │    │   (7 APIs)   │    │  (技术指标)   │               │
│  └──────┬───────┘    └──────┬───────┘    └──────┬───────┘               │
│         │                   │                   │                        │
│         └─────────┬─────────┴─────────┬─────────┘                        │
│                   ▼                   ▼                                  │
│         ┌─────────────────────────────────────┐                          │
│         │       AIDataAssembler (预处理)       │                          │
│         │   - 数据格式转换                     │                          │
│         │   - 趋势计算 (RISING/FALLING/STABLE) │                          │
│         │   - 单位转换 (BTC → USD)             │                          │
│         └─────────────────┬───────────────────┘                          │
│                           ▼                                              │
│         ┌─────────────────────────────────────┐                          │
│         │     MultiAgentAnalyzer (AI 决策)     │                          │
│         │   - Bull/Bear 辩论                   │                          │
│         │   - Judge 量化决策                   │                          │
│         │   - Risk 评估                        │                          │
│         └─────────────────┬───────────────────┘                          │
│                           ▼                                              │
│         ┌─────────────────────────────────────┐                          │
│         │       本地执行 + 风控 (待完善)        │                          │
│         │   - 支撑阻力位检查 ❌ 缺失            │                          │
│         │   - 订单执行                         │                          │
│         └─────────────────────────────────────┘                          │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

**设计原则**:
- 本地只负责数据预处理，不做交易判断
- 所有决策由 AI (MultiAgent Judge) 执行
- 本地负责风控边界检查和执行

---

## 一、Binance K线数据 (12 列)

| # | 字段名 | 数据类型 | 说明 | 1D | 4H | 15M | 采用状态 | 用途 | 建议 |
|---|-------|---------|------|:--:|:--:|:---:|---------|------|------|
| 1 | `open_time` | int64 | 开盘时间戳 (ms) | ✅ | ✅ | ✅ | ✅ 已用 | 时间索引 | - |
| 2 | `open` | float | 开盘价 | ✅ | ✅ | ✅ | ✅ 已用 | 技术指标 | - |
| 3 | `high` | float | 最高价 | ✅ | ✅ | ✅ | ✅ 已用 | 支撑阻力/BB | - |
| 4 | `low` | float | 最低价 | ✅ | ✅ | ✅ | ✅ 已用 | 支撑阻力/BB | - |
| 5 | `close` | float | 收盘价 | ✅ | ✅ | ✅ | ✅ 已用 | 所有指标 | - |
| 6 | `volume` | float | 成交量 (BTC) | ✅ | ✅ | ✅ | ⚠️ 部分 | 量价分析 | 加强使用 |
| 7 | `close_time` | int64 | 收盘时间戳 (ms) | ✅ | ✅ | ✅ | ❌ 未用 | - | 可选 |
| 8 | `quote_volume` | float | 成交额 (USDT) | ✅ | ✅ | ✅ | ✅ 已用 | 订单流分析 | - |
| 9 | `trades_count` | int | 成交笔数 | ✅ | ✅ | ✅ | ✅ 已用 | 平均交易额 | - |
| 10 | `taker_buy_base` | float | Taker买入量 (BTC) | ✅ | ✅ | ✅ | ✅ 已用 | Buy Ratio | - |
| 11 | `taker_buy_quote` | float | Taker买入额 (USDT) | ✅ | ✅ | ✅ | ✅ 已用 | CVD 计算 | - |
| 12 | `ignore` | - | 忽略字段 | - | - | - | ❌ 未用 | - | - |

**K线利用率: 10/12 = 83%** ✅

**支持的时间周期**: 1m, 3m, 5m, 15m, 30m, 1h, 2h, 4h, 6h, 8h, 12h, 1d, 3d, 1w, 1M

---

## 二、Binance 衍生品 API

| API 端点 | 数据字段 | 返回格式 | 1D | 4H | 15M | 采用状态 | 用途 | 建议 |
|---------|---------|---------|:--:|:--:|:---:|---------|------|------|
| `/futures/data/topLongShortAccountRatio` | 大户账户比 | `longAccount`, `shortAccount`, `longShortRatio` | ❌ | ✅ | ❌ | ✅ 已用 | 大户情绪 | - |
| `/futures/data/topLongShortPositionRatio` | 大户持仓比 ⭐ | `longAccount`, `shortAccount`, `longShortRatio` | ❌ | ✅ | ❌ | ✅ 已用 | 大户仓位 | 核心指标 |
| `/futures/data/takerlongshortRatio` | Taker买卖比 ⭐ | `buySellRatio`, `buyVol`, `sellVol` | ❌ | ✅ | ❌ | ✅ 已用 | 即时力量 | 核心指标 |
| `/futures/data/openInterestHist` | OI历史 | `sumOpenInterest`, `sumOpenInterestValue` | ❌ | ✅ | ❌ | ✅ 已用 | OI趋势 | - |
| `/fapi/v1/fundingRate` | 资金费率历史 | `fundingRate`, `fundingTime` | ❌ | ✅ | ❌ | ✅ 已用 | 费率趋势 | - |
| `/fapi/v1/ticker/24hr` | 24h行情 | `priceChange`, `volume`, `highPrice`, `lowPrice` | ❌ | ✅ | ❌ | ✅ 已用 | 波动统计 | - |
| `/futures/data/globalLongShortAccountRatio` | 全市场多空比 | `longAccount`, `shortAccount` | ❌ | ✅ | ❌ | ✅ 已用 | 市场情绪 | via sentiment_client |
| `/fapi/v1/depth` | 订单簿深度 ⭐ | `bids`, `asks` (价格,数量) | ❌ | ❌ | ❌ | ❌ **未用** | 支撑阻力 | 🔴 **建议添加** |
| `/fapi/v1/aggTrades` | 聚合成交 | `price`, `quantity`, `isBuyerMaker` | ❌ | ❌ | ❌ | ❌ 未用 | 大单识别 | 可选 |

**Binance 衍生品利用率: 7/9 = 78%**

**支持的周期 (period 参数)**: 5m, 15m, 30m, 1h, 2h, 4h, 6h, 12h, 1d

---

## 三、Coinalyze API

| API 端点 | 数据字段 | 返回格式 | 1D | 4H | 15M | 采用状态 | 用途 | 建议 |
|---------|---------|---------|:--:|:--:|:---:|---------|------|------|
| `/v1/open-interest` | 当前OI | `value` (BTC), `symbol` | ❌ | ✅ | ❌ | ✅ 已用 | OI水平 | - |
| `/v1/open-interest-history` | OI历史 | `history` [{`t`, `c`}] | ❌ | ✅ | ❌ | ✅ 已用 | OI趋势 | - |
| `/v1/funding-rate` | 当前资金费率 | `value` (小数) | ❌ | ✅ | ❌ | ✅ 已用 | 费率水平 | - |
| `/v1/funding-rate-history` | 资金费率历史 | `history` [{`t`, `o`}] | ❌ | ✅ | ❌ | ✅ 已用 | 费率趋势 | - |
| `/v1/liquidation` | 爆仓数据 | `history` [{`t`, `l`, `s`}] | ❌ | ✅ | ❌ | ✅ 已用 | 极端行情 | - |
| `/v1/long-short-ratio` | 当前多空比 | `value`, `l`, `s` | ❌ | ✅ | ❌ | ✅ 已用 | 多空情绪 | - |
| `/v1/long-short-ratio-history` | 多空比历史 | `history` [{`t`, `r`, `l`, `s`}] | ❌ | ✅ | ❌ | ✅ 已用 | 多空趋势 | - |

**Coinalyze 利用率: 7/7 = 100%** ✅

**注意**: Coinalyze **不提供**订单簿深度数据

---

## 四、技术指标 (本地计算)

| 指标 | 参数 | 1D (趋势层) | 4H (决策层) | 15M (执行层) | 用途 | 状态 |
|------|------|:----------:|:----------:|:-----------:|------|------|
| SMA | 200 | ✅ | ❌ | ❌ | 长期趋势 | ✅ 已用 |
| SMA | 50 | ❌ | ✅ | ❌ | 中期趋势 | ✅ 已用 |
| SMA | 20 | ❌ | ✅ | ✅ | 短期趋势 | ✅ 已用 |
| SMA | 5 | ❌ | ❌ | ✅ | 快速趋势 | ✅ 已用 |
| EMA | 12, 26 | ✅ | ✅ | ❌ | MACD 基础 | ✅ 已用 |
| EMA | 10, 20 | ❌ | ❌ | ✅ | 快速均线 | ✅ 已用 |
| RSI | 14 | ✅ | ✅ | ✅ | 超买超卖 | ✅ 已用 |
| MACD | 12/26/9 | ✅ | ✅ | ✅ | 动量 | ✅ 已用 |
| BB | 20, 2.0 | ✅ | ✅ | ✅ | 波动率 | ✅ 已用 |
| 支撑位 | K线低点 | ❌ | ❌ | ⚠️ 弱 | 风控 | 🔴 **需加强** |
| 阻力位 | K线高点 | ❌ | ❌ | ⚠️ 弱 | 风控 | 🔴 **需加强** |

---

## 五、数据周期覆盖矩阵

| 数据类型 | 1m | 5m | 15m | 30m | 1h | 4h | 1d | 1w | 当前采用 |
|---------|:--:|:--:|:---:|:---:|:--:|:--:|:--:|:--:|---------|
| Binance K线 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | 15m, 4h, 1d |
| Binance 衍生品 | ❌ | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ | ❌ | 15m→4h |
| Binance 订单簿 | 实时 | - | - | - | - | - | - | - | ❌ 未用 |
| Coinalyze | - | - | ✅ | - | ✅ | ✅ | - | - | 1h→4h |

---

## 六、缺失数据和改进建议

### P0 - 高优先级 (影响核心功能)

| 缺失项 | 数据源 | API 端点 | 影响 | 建议方案 |
|-------|-------|---------|------|---------|
| **订单簿深度** | Binance | `/fapi/v1/depth` | 无法准确识别支撑阻力 | 添加 BinanceOrderBookClient |
| **支撑阻力风控** | 本地计算 | - | 无法执行"接近阻力不做多" | 订单簿+K线综合计算 |

### P1 - 中优先级 (提升质量)

| 缺失项 | 数据源 | 影响 | 建议 |
|-------|-------|------|------|
| 趋势层外部数据 | - | 1D 层仅用技术指标 | 考虑添加周线 OI 变化 |
| 执行层实时数据 | Binance | 入场确认仅用 RSI | 考虑实时 Taker 数据 |

### P2 - 低优先级 (可选增强)

| 缺失项 | 数据源 | 影响 | 建议 |
|-------|-------|------|------|
| 聚合成交 (aggTrades) | Binance | 缺少大单识别 | 可选添加 |
| close_time | Binance K线 | 未使用 | 保持忽略 |

---

## 七、支撑阻力位计算方案

### 当前实现 (弱)

```python
# indicators/technical_manager.py
support = min(recent_lows[-lookback:])
resistance = max(recent_highs[-lookback:])
```

仅基于 K线高低点，无法反映真实挂单分布。

### 建议方案 (订单簿+K线)

```
┌─────────────────────────────────────────────────────────────────────────┐
│  支撑阻力位计算方案                                                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  1. 获取订单簿深度 (Binance /fapi/v1/depth, limit=500)                   │
│     {                                                                    │
│       "bids": [["82500.00", "15.5"], ["82000.00", "28.3"], ...],         │
│       "asks": [["83500.00", "12.8"], ["84000.00", "35.2"], ...]          │
│     }                                                                    │
│                                                                          │
│  2. 识别大单密集区                                                       │
│     - 计算每个价位的累计挂单量                                           │
│     - 找到超过平均值 2x 的价位 = 关键位                                  │
│                                                                          │
│  3. 结合 K线高低点                                                       │
│     - K线支撑: min(recent_lows[-20:])                                   │
│     - K线阻力: max(recent_highs[-20:])                                  │
│     - 综合支撑 = 靠近 K线支撑的买单密集区                                │
│     - 综合阻力 = 靠近 K线阻力的卖单密集区                                │
│                                                                          │
│  4. 风控应用                                                             │
│     - 当前价接近综合阻力 (< 0.5%) → 禁止做多                             │
│     - 当前价接近综合支撑 (< 0.5%) → 禁止做空                             │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 八、数据利用率统计

| 数据源 | 可用 API | 已用 API | 利用率 |
|-------|:--------:|:--------:|:------:|
| Binance K线 | 12 列 | 10 列 | 83% |
| Binance 衍生品 | 9 个 | 7 个 | 78% |
| Coinalyze | 7 个 | 7 个 | 100% |
| **总体** | **28** | **24** | **86%** |

### 关键缺失

```
┌────────────────────────────────────────────────────────────────────────┐
│  ❌ 订单簿深度 (Binance /fapi/v1/depth)                                 │
│     - 影响: 无法准确计算支撑阻力位                                      │
│     - 结果: "接近阻力不做多，接近支撑不做空" 功能无法实现                │
│     - 优先级: P0                                                        │
└────────────────────────────────────────────────────────────────────────┘
```

---

## 九、参考链接

- [Binance Futures API 文档](https://developers.binance.com/docs/derivatives/usds-margined-futures/market-data/)
- [Binance Order Book API](https://developers.binance.com/docs/derivatives/usds-margined-futures/market-data/websocket-api/Order-Book)
- [Coinalyze API 文档](https://api.coinalyze.net/v1/doc/)

---

## 十、更新记录

| 日期 | 版本 | 变更内容 |
|------|------|---------|
| 2026-01-31 | v3.0 | 初始文档，完整数据矩阵 |
