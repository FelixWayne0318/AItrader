# AItrader 数据流与决策逻辑完整文档

> 版本: v3.1 | 更新日期: 2026-01-30
>
> **v3.1 更新**: 移除趋势方向权限检查，完全符合 TradingAgents 职责划分
> **v3.0 重大更新**: AI 完全自主决策架构，移除所有本地硬编码规则

## 目录

1. [系统架构概览](#1-系统架构概览)
2. [数据流详解](#2-数据流详解)
3. [决策逻辑详解](#3-决策逻辑详解)
4. [与 TradingAgents 对比](#4-与-tradingagents-对比)
5. [本地 vs AI 职责划分](#5-本地-vs-ai-职责划分)
6. [关键代码位置索引](#6-关键代码位置索引)

---

## 1. 系统架构概览

### 1.1 设计理念 (v3.1)

**核心原则**: "Autonomy is non-negotiable" - AI 应像人类分析师一样思考

- **本地职责**: 仅收集原始数据 + 支撑/阻力位边界检查
- **AI 职责**: 完全自主分析数据、判断趋势、做出决策
- **执行层**: 仅支撑/阻力位 1% 硬风控

### 1.2 整体流程图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         on_timer() 每 15 分钟触发                            │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  PHASE 1: 数据聚合层 (Data Assembly) - 仅原始数据                            │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐       │
│  │ 技术指标     │ │ 订单流       │ │ 衍生品数据   │ │ 情绪数据     │       │
│  │ (15M/4H/1D)  │ │ (Binance)    │ │ (Coinalyze)  │ │ (多空比)     │       │
│  └──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘       │
│                                                                              │
│  ⚠️ v3.0: 不做任何预解读 (无 BULLISH/BEARISH 标签)                          │
│     AI 看到: "Buy Ratio: 60%" 而非 "Buy Ratio: 60% (BULLISH)"              │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  PHASE 2: AI 多代理分析 (4 次 API 调用) - AI 完全自主决策                     │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │ Step 1: Bull Analyst (看多论据)          ← 自主分析原始数据          │  │
│  │ Step 2: Bear Analyst (看空论据)          ← 自主分析原始数据          │  │
│  │ Step 3: Judge (自主决策)                 ← 评估辩论，自主判断        │  │
│  │ Step 4: Risk Manager (风险评估)          ← 自主设定 SL/TP/仓位       │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  ⚠️ v3.1: AI 完全自主判断趋势方向，无本地方向性权限检查                     │
│     Judge 自主评估证据强度，做出 LONG/SHORT/HOLD 决策                       │
│                                                                              │
│  输出: { signal, confidence, stop_loss, take_profit, risk_level }          │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  PHASE 3: 本地风控 (仅支撑/阻力位边界检查)                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 唯一规则: 支撑/阻力位硬风控                                         │   │
│  │   - 离支撑位 < 1% + SELL 信号 → HOLD (支撑位保护)                   │   │
│  │   - 离阻力位 < 1% + BUY 信号 → HOLD (阻力位保护)                    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
│  ⚠️ v3.1 移除的本地判断:                                                    │
│     ❌ 趋势方向权限检查 (allow_long/allow_short) - AI 自主判断              │
│     ❌ 仓位乘数调整 (multiplier) - AI 自主决定仓位                          │
│     ❌ 决策层方向匹配检查 (ALLOW_LONG/ALLOW_SHORT)                          │
│     ❌ RSI 入场范围 [35, 65]                                                │
│     ❌ 确认计数框架 (bullish_count/bearish_count)                           │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  PHASE 5: 仓位管理决策 (本地逻辑)                                            │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 无仓位 → 开新仓 (Bracket Order: Entry + SL + TP)                    │   │
│  │ 同方向 → 加仓/减仓 (Simple Market Order)                            │   │
│  │ 反方向 → 平仓 + 开反向仓 (需满足反转条件)                           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  PHASE 6: 订单执行 (NautilusTrader)                                          │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ • 验证 AI 的 SL/TP (防御性检查，非决策)                             │   │
│  │ • 无效时回退到技术分析计算                                          │   │
│  │ • 提交订单到 Binance                                                │   │
│  │ • OCO 自动管理 (SL 触发 → 取消 TP，反之亦然)                        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 数据流详解

### 2.1 数据源列表

| 数据类型 | 数据源 | 模块 | 代码位置 |
|---------|--------|------|----------|
| **技术指标 (15M)** | NautilusTrader | `indicators/technical_manager.py` | `deepseek_strategy.py:1301-1303` |
| **技术指标 (4H)** | MTF Manager | `indicators/multi_timeframe_manager.py` | `deepseek_strategy.py:1310-1324` |
| **技术指标 (1D)** | MTF Manager | `indicators/multi_timeframe_manager.py` | `deepseek_strategy.py:1383-1397` |
| **订单流** | Binance Kline API | `utils/binance_kline_client.py` | `deepseek_strategy.py:1431-1450` |
| **衍生品数据** | Coinalyze API | `utils/coinalyze_client.py` | `deepseek_strategy.py:1452-1467` |
| **情绪数据** | Binance 多空比 | `utils/sentiment_client.py` | `deepseek_strategy.py:1332-1351` |

### 2.2 技术指标详情

**15M 执行层 (Execution Layer)**:
```python
{
    'rsi': 35.2,              # RSI 相对强弱指数
    'macd': 50.5,             # MACD 值
    'macd_signal': 45.0,      # MACD 信号线
    'macd_histogram': 5.5,    # MACD 柱状图
    'bb_upper': 46000,        # 布林带上轨
    'bb_middle': 45000,       # 布林带中轨
    'bb_lower': 44000,        # 布林带下轨
    'sma_20': 44900,          # 20 周期 SMA
    'sma_50': 44500,          # 50 周期 SMA
    'support': 44000,         # 支撑位
    'resistance': 46000,      # 阻力位
    'overall_trend': 'BULLISH' # 整体趋势
}
```

**4H 决策层 (Decision Layer)**:
```python
{
    'timeframe': '4H',
    'rsi': 50.0,
    'macd': 100.0,
    'macd_signal': 80.0,
    'sma_20': 44800,
    'sma_50': 44200,
    'sma_200': 43000,         # 仅 4H 有 SMA_200
}
```

**1D 趋势层 (Trend Layer)**:
```python
{
    'timeframe': '1D',
    'sma_200': 43000,
    'macd': 500.0,
    'price_vs_sma200': 'ABOVE',  # 价格相对 SMA200 位置
}
```

### 2.3 订单流数据

```python
# 来源: Binance 12 列 K 线数据
{
    'buy_ratio': 0.56,         # 买盘占比 (taker_buy_volume / total_volume)
    'cvd_trend': 'RISING',     # 累积成交量差趋势 (RISING/FALLING/NEUTRAL)
    'avg_trade_size': 5000,    # 平均成交额 (USD)
    'volume_ratio': 1.2,       # 成交量相对均值比率
}
```

**计算逻辑** (`utils/order_flow_processor.py`):
```python
buy_ratio = sum(taker_buy_quote_volume) / sum(quote_volume)
cvd = cumsum(taker_buy_volume - taker_sell_volume)
cvd_trend = 'RISING' if cvd[-1] > cvd[0] else 'FALLING'
```

### 2.4 衍生品数据

```python
# 来源: Coinalyze API
{
    'open_interest_usd': 15000000000,  # 持仓量 (USD)
    'oi_change_pct': 5.2,              # 持仓量变化百分比
    'funding_rate': 0.0085,            # 资金费率 (%)
    'liquidations_1h_usd': 50000000,   # 1小时爆仓金额 (USD)
    'long_liquidations': 30000000,     # 多头爆仓
    'short_liquidations': 20000000,    # 空头爆仓
}
```

### 2.5 情绪数据

```python
# 来源: Binance 多空比 API
{
    'long_short_ratio': 1.15,    # 多空比 (>1 多头优势)
    'positive_ratio': 0.53,      # 正面情绪占比
    'negative_ratio': 0.47,      # 负面情绪占比
    'net_sentiment': 0.06,       # 净情绪 (positive - negative)
}
```

---

## 3. 决策逻辑详解

### 3.1 AI 多代理架构

```
┌─────────────────────────────────────────────────────────────────┐
│                    Phase 1: Bull/Bear 辩论                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐           ┌─────────────────┐            │
│  │  Bull Analyst   │           │  Bear Analyst   │            │
│  │  (看多代理)     │    VS     │  (看空代理)     │            │
│  │                 │           │                 │            │
│  │ • 价格 > SMA    │           │ • 价格 < SMA    │            │
│  │ • RSI 上升      │           │ • RSI 超买      │            │
│  │ • 买盘 > 56%    │           │ • 卖压增加      │            │
│  │ • OI 上升       │           │ • Funding 过高  │            │
│  └─────────────────┘           └─────────────────┘            │
│                                                                 │
│  Temperature: 0.3 (平衡创造性)                                  │
│  输出: 结构化论据 + 数据支撑                                    │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Phase 2: Judge 量化决策                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  确认计数算法 (0-5 分制):                                       │
│                                                                 │
│  多头确认 (Bullish Confirmations):                              │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 1. 价格 > SMA20 或 SMA50          (+1)                  │   │
│  │ 2. RSI < 55 (非超买)              (+1)                  │   │
│  │ 3. MACD > Signal 或 柱状图 > 0    (+1)                  │   │
│  │ 4. 价格接近支撑或 BB 下轨 (1%)    (+1)                  │   │
│  │ 5. 成交量比率 > 1.0 或买盘主导    (+1)                  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  空头确认 (Bearish Confirmations):                              │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 1. 价格 < SMA20 且 < SMA50        (+1) ← 两者都需要     │   │
│  │ 2. RSI > 65 (超买)                (+1)                  │   │
│  │ 3. MACD < Signal 或 柱状图 < 0    (+1)                  │   │
│  │ 4. 价格接近阻力或 BB 上轨 (1%)    (+1)                  │   │
│  │ 5. 成交量比率 < 0.8 或卖盘主导    (+1)                  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  决策规则:                                                      │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ IF bullish_count >= 3:                                  │   │
│  │     → LONG (HIGH confidence)                            │   │
│  │ ELSE IF bearish_count >= 3:                             │   │
│  │     → SHORT (HIGH confidence)                           │   │
│  │ ELSE IF count == 2 AND leading > other:                 │   │
│  │     → LONG/SHORT (MEDIUM confidence)                    │   │
│  │ ELSE:                                                   │   │
│  │     → HOLD (LOW confidence)                             │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  Temperature: 0.1 (高度确定性)                                  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Phase 3: Risk 评估                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  AI 输出:                                                       │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ • signal: 'BUY' / 'SELL' / 'HOLD'                       │   │
│  │ • confidence: 'HIGH' / 'MEDIUM' / 'LOW'                 │   │
│  │ • stop_loss: 43500 (1.5-2% 距离)                        │   │
│  │ • take_profit: 46500 (基于信心级别)                     │   │
│  │ • position_size_pct: 100 (25/50/100)                    │   │
│  │ • risk_level: 'LOW' / 'MEDIUM' / 'HIGH'                 │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  SL/TP 约束:                                                    │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ LONG: SL 在入场价下方 1.5-2%, 最小 1%                   │   │
│  │ SHORT: SL 在入场价上方 1.5-2%, 最小 1%                  │   │
│  │ TP: HIGH=2-3%, MEDIUM=1.5-2%, LOW=1%                    │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  Temperature: 0.5 (中等)                                        │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 MTF 三层过滤逻辑

```
┌─────────────────────────────────────────────────────────────────┐
│  Layer 1: 趋势层 (1D) - 市场状态判断                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  输入: 当前价格, SMA_200, MACD                                  │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ IF price > SMA_200 AND MACD > 0:                        │   │
│  │     regime = 'BULL'                                     │   │
│  │     allow_long = True                                   │   │
│  │     allow_short = True                                  │   │
│  │     position_multiplier = 1.2                           │   │
│  │                                                         │   │
│  │ ELSE IF price < SMA_200 AND MACD < 0:                   │   │
│  │     regime = 'BEAR'                                     │   │
│  │     allow_long = False    ← 禁止做多                    │   │
│  │     allow_short = True    ← 允许做空 (v2.0 修复)        │   │
│  │     position_multiplier = 1.0                           │   │
│  │                                                         │   │
│  │ ELSE:                                                   │   │
│  │     regime = 'SIDEWAYS'                                 │   │
│  │     allow_long = True                                   │   │
│  │     allow_short = True                                  │   │
│  │     position_multiplier = 0.7  ← 降低仓位               │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  代码位置: multi_timeframe_manager.py:353-434                   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  Layer 2: 决策层 (4H) - 方向匹配检查                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  决策状态: ALLOW_LONG / ALLOW_SHORT / WAIT                      │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ IF signal == 'BUY' AND state == ALLOW_SHORT:            │   │
│  │     → signal = 'HOLD' (方向冲突)                        │   │
│  │                                                         │   │
│  │ IF signal == 'SELL' AND state == ALLOW_LONG:            │   │
│  │     → signal = 'HOLD' (方向冲突)                        │   │
│  │                                                         │   │
│  │ IF state == WAIT:                                       │   │
│  │     → signal = 'HOLD' (市场不明朗)                      │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  代码位置: deepseek_strategy.py:1551-1578                       │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  Layer 3: 执行层 (15M) - RSI 入场确认                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  RSI 入场范围: [35, 65]                                         │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ IF RSI < 35:                                            │   │
│  │     → signal = 'HOLD'                                   │   │
│  │     reason = "RSI 过低，可能反弹"                       │   │
│  │                                                         │   │
│  │ IF RSI > 65:                                            │   │
│  │     → signal = 'HOLD'                                   │   │
│  │     reason = "RSI 过高，可能回调"                       │   │
│  │                                                         │   │
│  │ IF 35 <= RSI <= 65:                                     │   │
│  │     → 允许执行                                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
│  代码位置: deepseek_strategy.py:1580-1594                       │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. 与 TradingAgents 对比

### 4.1 架构对比

| 组件 | TradingAgents (UCLA/MIT) | AItrader | 差异说明 |
|------|--------------------------|----------|----------|
| **分析师团队** | 4 个独立分析师 (基本面/情绪/新闻/技术) | Bull/Bear 2 代理对抗 | AItrader 简化为辩论模式 |
| **研究员团队** | Bull/Bear 研究员辩论 | 集成在 Bull/Bear Analyst | 功能等价 |
| **交易员** | Trader Agent 综合推荐 | Judge Agent 量化决策 | AItrader 用确认计数替代主观判断 |
| **风险管理** | Risk Manager + Portfolio Manager | Risk Evaluation (单一 Agent) | AItrader 简化为单层 |
| **MTF 过滤** | 无 | 三层过滤 (1D/4H/15M) | **AItrader 独创扩展** |
| **硬风控** | 依赖人工监督 | 本地代码强制执行 | 24/7 自动化必需 |

### 4.2 数据流对比

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        TradingAgents 数据流                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐    │
│  │ Fundamentals│   │ Sentiment   │   │ News        │   │ Technical   │    │
│  │ (Alpha V.)  │   │ (社交媒体)  │   │ (Alpha V.)  │   │ (yfinance)  │    │
│  └──────┬──────┘   └──────┬──────┘   └──────┬──────┘   └──────┬──────┘    │
│         │                 │                 │                 │            │
│         └────────────────┼─────────────────┼─────────────────┘            │
│                          │                 │                              │
│                          ▼                 ▼                              │
│                   ┌──────────────────────────┐                            │
│                   │  4 个独立分析师 Agent     │                            │
│                   │  (各自分析不同数据)       │                            │
│                   └────────────┬─────────────┘                            │
│                                │                                          │
│                                ▼                                          │
│                   ┌──────────────────────────┐                            │
│                   │  Bull/Bear 研究员辩论    │                            │
│                   └────────────┬─────────────┘                            │
│                                │                                          │
│                                ▼                                          │
│                   ┌──────────────────────────┐                            │
│                   │  Trader Agent 综合推荐   │                            │
│                   └────────────┬─────────────┘                            │
│                                │                                          │
│                                ▼                                          │
│                   ┌──────────────────────────┐                            │
│                   │  Risk + Portfolio Manager│                            │
│                   └────────────┬─────────────┘                            │
│                                │                                          │
│                                ▼                                          │
│                         模拟交易执行                                       │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                          AItrader 数据流                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐    │
│  │ Technical   │   │ Order Flow  │   │ Derivatives │   │ Sentiment   │    │
│  │ (15M/4H/1D) │   │ (Binance)   │   │ (Coinalyze) │   │ (多空比)    │    │
│  └──────┬──────┘   └──────┬──────┘   └──────┬──────┘   └──────┬──────┘    │
│         │                 │                 │                 │            │
│         │                 │                 │                 │            │
│         │    ┌────────────┴─────────────────┴─────────────────┘            │
│         │    │                                                             │
│         ▼    ▼                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │  MTF 趋势层 (1D) - 本地硬风控                                        │  │
│  │  [RISK_ON / RISK_OFF 判断]                                          │  │
│  └────────────────────────────────────┬────────────────────────────────┘  │
│                                       │ RISK_ON                           │
│                                       ▼                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │  Bull/Bear 辩论 (2 API calls)                                        │  │
│  │  [所有 4 类数据打包发送给 AI]                                        │  │
│  └────────────────────────────────────┬────────────────────────────────┘  │
│                                       │                                   │
│                                       ▼                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │  Judge 量化决策 (1 API call)                                         │  │
│  │  [确认计数算法: Bullish X/5, Bearish Y/5]                           │  │
│  └────────────────────────────────────┬────────────────────────────────┘  │
│                                       │                                   │
│                                       ▼                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │  Risk Evaluation (1 API call)                                        │  │
│  │  [SL/TP 定价, 仓位大小]                                              │  │
│  └────────────────────────────────────┬────────────────────────────────┘  │
│                                       │                                   │
│                                       ▼                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │  MTF 信号过滤 (4H + 15M) - 本地检查                                  │  │
│  │  [方向匹配 + RSI 确认]                                               │  │
│  └────────────────────────────────────┬────────────────────────────────┘  │
│                                       │                                   │
│                                       ▼                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐  │
│  │  本地仓位管理 + 订单执行                                             │  │
│  │  [Bracket Order / SL/TP 验证 / OCO 管理]                            │  │
│  └─────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.3 关键差异总结

| 方面 | TradingAgents | AItrader | 优劣分析 |
|------|---------------|----------|----------|
| **API 调用次数** | 6-8 次 (4 分析师 + 辩论 + 综合 + 风控) | 4 次 (Bull + Bear + Judge + Risk) | AItrader 更高效 |
| **数据分析师** | 各自独立分析 | 统一数据包发送 | AItrader 减少信息损失 |
| **决策方式** | Trader Agent 主观综合 | Judge 确认计数 (量化规则) | AItrader 更可预测 |
| **风险管理** | 2 层 (Risk + Portfolio) | 1 层 + MTF 硬风控 | AItrader 更适合自动化 |
| **MTF 过滤** | 无 | 三层过滤 (1D/4H/15M) | **AItrader 独创，防止逆势交易** |
| **人工监督** | 必需 | 可选 (24/7 自动) | AItrader 更自治 |
| **适用场景** | 研究/回测/辅助决策 | 实盘自动交易 | 定位不同 |

### 4.4 AItrader 相对 TradingAgents 的改进

1. **MTF 硬风控** - TradingAgents 假设有人监督，AItrader 必须有熔断机制
2. **确认计数** - 用量化规则替代 AI 的主观 "综合判断"，减少 HOLD 偏向
3. **方向性权限** - 熊市允许做空 (v2.0 修复)，而非完全阻止交易
4. **RSI 入场保护** - 避免在极端位置入场 (TradingAgents 无此机制)
5. **数据打包** - 4 类数据统一发送，AI 看到完整图景

---

## 5. 本地 vs AI 职责划分

### 5.1 职责矩阵

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              职责划分清单                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                         AI 决定 (4 API Calls)                         │ │
│  ├───────────────────────────────────────────────────────────────────────┤ │
│  │                                                                       │ │
│  │  ✅ 市场方向判断                                                      │ │
│  │     - Bull/Bear 辩论产出                                              │ │
│  │     - 基于 4 类数据的综合分析                                         │ │
│  │                                                                       │ │
│  │  ✅ 最终信号                                                          │ │
│  │     - BUY / SELL / HOLD                                               │ │
│  │     - 确认计数: Bullish X/5, Bearish Y/5                              │ │
│  │                                                                       │ │
│  │  ✅ 信心级别                                                          │ │
│  │     - HIGH (>=3 确认) / MEDIUM (2 确认) / LOW (<2 确认)               │ │
│  │                                                                       │ │
│  │  ✅ 止损价格 (建议)                                                   │ │
│  │     - 基于支撑/阻力 + 风险评估                                        │ │
│  │     - 必须 >= 1% 距离 (由本地验证)                                    │ │
│  │                                                                       │ │
│  │  ✅ 止盈价格 (建议)                                                   │ │
│  │     - 基于信心级别: HIGH=2-3%, MEDIUM=1.5-2%, LOW=1%                  │ │
│  │                                                                       │ │
│  │  ✅ 风险级别                                                          │ │
│  │     - LOW / MEDIUM / HIGH                                             │ │
│  │     - 影响仓位大小建议                                                │ │
│  │                                                                       │ │
│  │  ✅ 仓位大小百分比 (建议)                                             │ │
│  │     - 25% / 50% / 100%                                                │ │
│  │     - 由本地代码最终计算实际数量                                      │ │
│  │                                                                       │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                      本地代码决定 (纯算法)                            │ │
│  ├───────────────────────────────────────────────────────────────────────┤ │
│  │                                                                       │ │
│  │  🔒 MTF 趋势过滤 (不可绕过)                                           │ │
│  │     - RISK_ON/RISK_OFF 判断                                           │ │
│  │     - 基于 SMA_200 + MACD 的硬规则                                    │ │
│  │                                                                       │ │
│  │  🔒 方向性权限 (不可绕过)                                             │ │
│  │     - 熊市: 禁止 BUY, 允许 SELL                                       │ │
│  │     - 牛市: 允许 BUY, 允许 SELL                                       │ │
│  │     - 震荡: 允许 BUY, 允许 SELL, 降仓 30%                             │ │
│  │                                                                       │ │
│  │  🔒 RSI 入场确认 (不可绕过)                                           │ │
│  │     - RSI 必须在 [35, 65] 范围                                        │ │
│  │     - 超出范围强制 HOLD                                               │ │
│  │                                                                       │ │
│  │  🔒 信心阈值检查                                                      │ │
│  │     - 低于 min_confidence_to_trade 时跳过                             │ │
│  │                                                                       │ │
│  │  🔒 SL/TP 验证                                                        │ │
│  │     - 最小 1% 距离强制执行                                            │ │
│  │     - 方向正确性检查 (LONG: SL < Entry, SHORT: SL > Entry)            │ │
│  │     - 无效时回退到技术分析计算                                        │ │
│  │                                                                       │ │
│  │  🔒 仓位大小计算                                                      │ │
│  │     - 基础金额 × 信心乘数 × 趋势乘数 × RSI 调整                       │ │
│  │     - 最大仓位比例 30% 硬限制                                         │ │
│  │     - 最小名义金额 $100 (Binance 要求)                                │ │
│  │                                                                       │ │
│  │  🔒 仓位管理逻辑                                                      │ │
│  │     - 无仓位 → 开新仓 (Bracket)                                       │ │
│  │     - 同方向 → 加仓/减仓 (Simple)                                     │ │
│  │     - 反方向 → 平仓 + 开新仓 (需满足反转条件)                         │ │
│  │                                                                       │ │
│  │  🔒 订单类型选择                                                      │ │
│  │     - 新仓位: Bracket Order (Entry + SL + TP)                         │ │
│  │     - 仓位管理: Simple Market Order                                   │ │
│  │                                                                       │ │
│  │  🔒 OCO 自动管理                                                      │ │
│  │     - SL 触发 → 自动取消 TP                                           │ │
│  │     - TP 触发 → 自动取消 SL                                           │ │
│  │                                                                       │ │
│  │  🔒 异常处理                                                          │ │
│  │     - API 失败时使用默认值                                            │ │
│  │     - 订单被拒时发送告警                                              │ │
│  │                                                                       │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 职责边界示意图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           AI 决策边界                                        │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │  "我认为应该 BUY, 信心 HIGH, SL 放在 43500, TP 放在 46500"           │ │
│  │                                                                       │ │
│  │  AI 的 output:                                                        │ │
│  │  {                                                                    │ │
│  │    "signal": "BUY",                                                   │ │
│  │    "confidence": "HIGH",                                              │ │
│  │    "stop_loss": 43500,                                                │ │
│  │    "take_profit": 46500,                                              │ │
│  │    "risk_level": "MEDIUM",                                            │ │
│  │    "position_size_pct": 100                                           │ │
│  │  }                                                                    │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                     │                                       │
│                                     │ AI 职责结束                           │
│                                     ▼                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                          本地代码接管                                        │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                                                                       │ │
│  │  Step 1: MTF 过滤 (可能否决 AI 决策)                                  │ │
│  │    - 趋势层: RISK_ON? → 继续                                          │ │
│  │    - 方向层: 允许 BUY? → 继续                                         │ │
│  │    - 执行层: RSI 在范围? → 继续                                       │ │
│  │                                                                       │ │
│  │  Step 2: 验证 SL/TP                                                   │ │
│  │    - SL 43500 距离 45000 = 3.3% ✓ (>= 1%)                            │ │
│  │    - SL 在入场价下方 ✓ (LONG 正确方向)                                │ │
│  │    - TP 46500 距离 45000 = 3.3% ✓                                     │ │
│  │    → 使用 AI 值                                                       │ │
│  │                                                                       │ │
│  │  Step 3: 计算仓位大小                                                 │ │
│  │    - 基础: $100                                                       │ │
│  │    - HIGH 信心: ×1.5 = $150                                           │ │
│  │    - 强上升趋势: ×1.2 = $180                                          │ │
│  │    - RSI 正常: ×1.0 = $180                                            │ │
│  │    - 检查 max_position_ratio: $180 < 30% of $1000 ✓                   │ │
│  │    → 最终: $180 / $45000 = 0.004 BTC                                  │ │
│  │                                                                       │ │
│  │  Step 4: 提交订单                                                     │ │
│  │    - 类型: Bracket Order                                              │ │
│  │    - Entry: MARKET @ ~45000                                           │ │
│  │    - SL: 43500 (STOP_MARKET)                                          │ │
│  │    - TP: 46500 (TAKE_PROFIT_MARKET)                                   │ │
│  │                                                                       │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                     │                                       │
│                                     │ 本地职责结束                          │
│                                     ▼                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                        NautilusTrader 框架接管                               │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                                                                       │ │
│  │  • 订单路由到 Binance                                                 │ │
│  │  • OCO 自动管理 (SL/TP 互斥)                                          │ │
│  │  • 事件回调 (on_order_filled, on_position_opened)                     │ │
│  │                                                                       │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.3 职责清晰度评估

| 评估维度 | 状态 | 说明 |
|---------|------|------|
| **AI 输出结构化** | ✅ 清晰 | JSON 格式，字段明确 |
| **AI 不做执行决策** | ✅ 清晰 | AI 只给建议，本地决定是否执行 |
| **MTF 硬风控** | ✅ 清晰 | 本地代码强制执行，AI 无法绕过 |
| **SL/TP 验证** | ✅ 清晰 | 本地验证 + 回退机制 |
| **仓位计算** | ✅ 清晰 | 本地算法，AI 只提供百分比建议 |
| **异常处理** | ✅ 清晰 | 本地代码处理所有边缘情况 |

**结论**: 本地 vs AI 职责划分 **非常清晰**：
- AI 负责 **策略建议** (做什么)
- 本地代码负责 **风控执行** (怎么做 + 是否允许做)
- 框架负责 **基础设施** (订单路由 + OCO 管理)

---

## 6. 关键代码位置索引

| 功能模块 | 文件 | 行号 | 说明 |
|---------|------|------|------|
| **数据聚合** | `deepseek_strategy.py` | 1254-1478 | on_timer 主函数 |
| **技术指标** | `deepseek_strategy.py` | 1301-1303 | 15M 数据获取 |
| **4H 数据** | `deepseek_strategy.py` | 1310-1324 | 决策层数据 |
| **情绪数据** | `deepseek_strategy.py` | 1332-1351 | 多空比获取 |
| **订单流** | `deepseek_strategy.py` | 1431-1450 | Binance K线处理 |
| **衍生品** | `deepseek_strategy.py` | 1452-1467 | Coinalyze 数据 |
| **MTF 趋势过滤** | `deepseek_strategy.py` | 1378-1397 | RISK_ON/OFF 判断 |
| **AI 分析调用** | `deepseek_strategy.py` | 1399-1478 | MultiAgent 调用 |
| **Bull/Bear 辩论** | `multi_agent_analyzer.py` | 279-449 | 辩论 prompt |
| **Judge 决策** | `multi_agent_analyzer.py` | 452-596 | 确认计数逻辑 |
| **Risk 评估** | `multi_agent_analyzer.py` | 598-750+ | SL/TP + 仓位 |
| **方向性权限** | `multi_timeframe_manager.py` | 353-434 | allow_long/short |
| **信号过滤** | `deepseek_strategy.py` | 1484-1600 | 三层 MTF 过滤 |
| **仓位管理** | `deepseek_strategy.py` | 1978-2143 | 加仓/减仓/反转 |
| **Bracket 订单** | `deepseek_strategy.py` | 2197-2372 | SL/TP 提交 |
| **SL/TP 验证** | `trading_logic.py` | 340-450 | 距离 + 方向检查 |
| **仓位计算** | `trading_logic.py` | 200-350 | 大小算法 |

---

*文档生成时间: 2026-01-29*
*基于 commit: b272421*
