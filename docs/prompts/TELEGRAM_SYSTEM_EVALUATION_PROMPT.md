# 量化交易系统 Telegram 消息模块专家评估提示词

## 评估者角色设定

你是一位拥有 15+ 年经验的**顶级量化交易系统架构师**，曾在 Jane Street、Two Sigma、Citadel 等顶级量化机构担任技术负责人。你的专长包括：

- 高频交易系统架构设计
- 实时监控与告警系统
- 分布式交易系统运维
- 风险管理系统设计
- 交易员人机交互界面优化

你现在需要对一个加密货币 AI 交易系统的 **Telegram 消息模块** 进行全面的专业评估。

---

## 系统背景

**项目名称**: AItrader
**框架**: NautilusTrader 1.222.0 (高性能交易引擎)
**AI 引擎**: DeepSeek (多代理层级决策系统)
**交易标的**: BTC/USDT 永续合约 (Binance)
**Telegram 用途**: 实时通知 + 远程控制

---

## 待评估的代码模块

### 1. 核心通知模块 (utils/telegram_bot.py)

```python
class TelegramBot:
    """
    功能:
    - 异步/同步消息发送
    - Markdown 格式化与转义
    - 多种消息格式化器 (信号、成交、持仓、心跳等)
    - Markdown 解析失败自动重试
    """
```

**关键方法**:
- `send_message()` - 异步发送
- `send_message_sync()` - 同步发送 (使用 requests 绕过线程安全问题)
- `format_trade_signal()` - 交易信号通知
- `format_order_fill()` - 订单成交通知
- `format_position_update()` - 持仓变动通知
- `format_heartbeat_message()` - 心跳状态通知 (v3.1)
- `format_trailing_stop_update()` - 移动止损通知
- `format_error_alert()` - 错误告警

### 2. 命令处理模块 (utils/telegram_command_handler.py)

```python
class TelegramCommandHandler:
    """
    功能:
    - 命令认证 (allowed_chat_ids)
    - 查询命令: /status, /position, /orders, /history, /risk
    - 控制命令: /pause, /resume, /close
    - 交互式菜单: /menu (Inline Keyboard)
    - Webhook 冲突处理与重试
    """
```

### 3. 配置文件 (configs/telegram_config.yaml)

```yaml
通知类型:
  - trade_signals: 交易信号
  - order_fills: 订单成交
  - position_updates: 持仓变动
  - errors/warnings: 错误告警
  - heartbeat: 心跳状态

高级功能:
  - rate_limit: 速率限制
  - quiet_hours: 安静时段
  - retry_on_failure: 失败重试
```

### 4. 策略集成 (strategy/deepseek_strategy.py)

Telegram 在策略中的使用场景:
- 启动通知 (on_start)
- 每次 on_timer 发送心跳 (v2.1+)
- 信号生成后通知
- 订单成交通知
- 持仓开仓/平仓通知
- 移动止损更新通知
- 错误告警

---

## 评估维度与打分标准

请从以下 **8 个维度** 进行评估，每个维度 0-10 分：

### 1. 信息完整性 (Information Completeness) [0-10]

**评估要点**:
- 交易信号是否包含足够决策依据？(技术指标、AI 推理、支撑阻力)
- 订单成交是否包含关键信息？(价格、数量、滑点)
- 持仓通知是否包含风险信息？(止损位、止盈位、盈亏比)
- 心跳消息是否反映系统健康状态？
- 是否缺少关键业务信息？

**顶级实践对比**:
- Two Sigma: 交易通知包含预期滑点 vs 实际滑点对比
- Citadel: 持仓通知包含 Greeks 敏感度和 VaR 风险值
- Jump Trading: 心跳包含延迟监控和队列深度

### 2. 实时性与延迟 (Latency & Real-time) [0-10]

**评估要点**:
- 消息发送是否会阻塞交易主线程？
- 是否有消息队列机制避免堆积？
- 网络超时配置是否合理？
- 失败重试是否会导致消息风暴？
- 心跳间隔是否合理 (当前 15 分钟)？

**顶级实践对比**:
- 高频系统: 通知走独立线程/进程，永不阻塞交易路径
- 生产级系统: 消息队列 + 批量发送 + 去重
- 监控系统: 分级告警 (P0/P1/P2) 不同延迟要求

### 3. 安全性 (Security) [0-10]

**评估要点**:
- 认证机制是否足够？(allowed_chat_ids)
- 敏感信息是否会泄露？(API keys, 余额, 策略参数)
- 控制命令是否有二次确认？(/close 需要确认)
- 是否有防止重放攻击的机制？
- 日志中是否会暴露敏感信息？

**顶级实践对比**:
- 生产级: 双因素认证 + IP 白名单 + 操作审计日志
- 金融合规: 所有控制操作需要多人审批
- 安全最佳实践: 敏感字段脱敏 + 端到端加密

### 4. 可靠性与容错 (Reliability & Fault Tolerance) [0-10]

**评估要点**:
- Telegram API 故障时系统是否会崩溃？
- 消息发送失败是否有重试机制？
- Webhook 冲突是否正确处理？
- 是否有消息持久化避免丢失？
- 网络波动时的降级策略是什么？

**顶级实践对比**:
- 生产级: 消息持久化到本地 + 异步重试队列
- 高可用: 多通道冗余 (Telegram + SMS + Email)
- 灾难恢复: 消息重放机制

### 5. 用户体验 (User Experience) [0-10]

**评估要点**:
- 消息格式是否易读？(Markdown 格式化、emoji 使用)
- 信息层次是否清晰？(关键信息突出)
- 是否支持快速操作？(Inline Keyboard)
- 消息是否过于冗长或过于简短？
- 多语言支持如何？(当前中文为主)

**顶级实践对比**:
- 专业交易终端: 信息密度高但结构清晰
- 移动端优化: 关键数字一目了然，详情可展开
- 可定制: 用户可选择接收哪些类型通知

### 6. 可观测性 (Observability) [0-10]

**评估要点**:
- 心跳消息是否包含足够诊断信息？
- 错误告警是否包含上下文？
- 是否可以通过 Telegram 快速诊断问题？
- 历史消息是否可追溯？
- 是否有性能指标监控？

**顶级实践对比**:
- SRE 最佳实践: 结构化日志 + 分布式追踪 ID
- 监控金字塔: Metrics → Logs → Traces
- 告警分级: 不同严重程度不同处理流程

### 7. 可扩展性 (Extensibility) [0-10]

**评估要点**:
- 添加新的通知类型是否容易？
- 添加新的命令是否容易？
- 消息格式是否易于修改？
- 是否支持多用户/多策略？
- 是否易于集成其他通知渠道？

**顶级实践对比**:
- 插件架构: 通知渠道可插拔
- 模板系统: 消息格式配置化
- 多租户: 不同策略独立通知配置

### 8. 合规性 (Compliance) [0-10]

**评估要点**:
- 操作日志是否完整可审计？
- 是否满足金融监管要求？
- 数据保留策略是否合规？
- 跨境数据传输是否合规？(Telegram 服务器在境外)
- 是否有操作回溯机制？

**顶级实践对比**:
- 金融合规: 所有操作可审计 + 不可篡改日志
- 数据合规: 敏感数据加密存储 + 定期清理
- 监管报告: 自动生成合规报告

---

## 评估输出格式

请按以下格式输出评估报告:

```markdown
# Telegram 消息系统评估报告

## 综合评分

| 维度 | 得分 | 权重 | 加权得分 |
|------|------|------|----------|
| 信息完整性 | X/10 | 15% | X.XX |
| 实时性与延迟 | X/10 | 15% | X.XX |
| 安全性 | X/10 | 15% | X.XX |
| 可靠性与容错 | X/10 | 15% | X.XX |
| 用户体验 | X/10 | 10% | X.XX |
| 可观测性 | X/10 | 10% | X.XX |
| 可扩展性 | X/10 | 10% | X.XX |
| 合规性 | X/10 | 10% | X.XX |
| **总分** | - | 100% | **X.XX/10** |

## 各维度详细评估

### 1. 信息完整性 (X/10)

**优点**:
- ...

**缺陷**:
- ...

**改进建议**:
- ...

[其他维度类似...]

## 关键问题清单

### 🔴 严重问题 (必须修复)
1. ...

### 🟡 中等问题 (建议修复)
1. ...

### 🟢 轻微问题 (可选改进)
1. ...

## 与行业最佳实践差距分析

| 功能 | 当前实现 | 行业最佳实践 | 差距 |
|------|----------|--------------|------|
| ... | ... | ... | ... |

## 优先级排序的改进路线图

### Phase 1: 紧急修复 (1-2 周)
- ...

### Phase 2: 重要改进 (1 个月)
- ...

### Phase 3: 优化提升 (1 个季度)
- ...

## 总结

[总体评价和建议...]
```

---

## 特别关注点

评估时请特别关注以下问题:

### 1. 线程安全问题
当前实现中 `send_message_sync()` 使用 `requests` 而非 `python-telegram-bot` 的异步方法，原因是 v20+ 版本不是线程安全的。请评估这个设计决策是否合理。

### 2. 心跳频率问题
当前心跳每 15 分钟发送一次 (与 on_timer 同步)。请评估:
- 频率是否合理？
- 是否需要独立的心跳线程？
- 心跳失败是否应该触发告警？

### 3. 消息丢失风险
当前没有消息持久化机制，网络故障时消息会丢失。请评估:
- 哪些消息类型必须保证送达？
- 是否需要本地队列 + 重试机制？

### 4. 认证安全性
当前仅依赖 `allowed_chat_ids` 进行认证。请评估:
- 是否足够安全？
- 是否需要增加额外认证层？

### 5. 信息密度平衡
心跳消息包含大量数据 (价格、RSI、持仓、订单流、衍生品、订单簿、S/R Zone)。请评估:
- 信息是否过载？
- 是否需要分级展示？

---

## 附录: 代码位置参考

| 文件 | 行数 | 功能 |
|------|------|------|
| `utils/telegram_bot.py` | 1-787 | 核心通知类 |
| `utils/telegram_command_handler.py` | 1-653 | 命令处理类 |
| `configs/telegram_config.yaml` | 1-57 | 配置文件 |
| `strategy/deepseek_strategy.py:398-496` | - | 初始化集成 |
| `strategy/deepseek_strategy.py:1705-1828` | - | 心跳通知 |
| `strategy/deepseek_strategy.py:2027-2046` | - | 信号通知 |
| `strategy/deepseek_strategy.py:2427-2435` | - | 成交通知 |
| `tests/test_telegram.py` | 1-103 | 连接测试 |
| `tests/test_telegram_commands.py` | 1-171 | 命令测试 |

---

## 期望输出

请提供:
1. **量化评分** (8 个维度各自打分 + 加权总分)
2. **详细分析** (每个维度的优缺点)
3. **问题清单** (按严重程度分类)
4. **改进路线图** (按优先级排序)
5. **与行业最佳实践对比** (差距分析)

评估应该**客观、专业、可操作**，避免泛泛而谈，每个问题都应该有具体的代码引用和改进方案。
