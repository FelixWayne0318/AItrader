# S/R 有效性 + SL/TP + 仓位操作：评价标准 & 现状评估

> 版本: v2.2 | 日期: 2026-02-12
> 基于代码审计: sr_zone_calculator.py, sr_sltp_calculator.py (v4.3), deepseek_strategy.py, trading_logic.py, multi_agent_analyzer.py

### v2.2 变更日志 (深度审计 + AI/本地职责审查)

| 变更 | 说明 |
|------|------|
| **E5 审计修正** | "无最大持仓上限" → **L3335-3360 已实现累积 30% 硬限**。评分 2/5 → 4/5。P0 → **已关闭** |
| **E9 重新定义** | "风险被低估" → 实际用当前价计算 R/R 是**偏保守** (高估风险)，问题是可能过度拒绝合理加仓。P0 → **P2** |
| **C9 重新评估** | ATR buffer 已提供机械级 regime 适应 + AI 接收完整 ADX/regime 数据。添加硬编码 ADX 规则违反 AI 自主权。评分 2/5 → 3.5/5。P0 → **P2** |
| **C11 职责审查** | 新增 AI/本地职责分析: 强制 TP 单向可能违反 S/R 哲学 (保留无市场结构支撑的过时 TP) |
| **C12 职责审查** | 新增 AI/本地职责分析: 入场价非市场结构，与 S/R 系统哲学矛盾 |
| **P0 清空** | 3 项原 P0 全部关闭或降级，当前无 P0 问题 |
| **E 模块总分** | 3.2 → 3.6 (E5 累积限制确认) |
| **C 模块总分** | 3.2 → 3.4 (C9 隐式 regime 适应确认) |
| **加权总分** | 3.9 → 4.0 |

### v2.1 变更日志 (代码审计修正)

| 变更 | 说明 |
|------|------|
| **A10 审计修正** | "Bid Wall 方向过滤疑似 bug" → **代码逻辑正确，bug 不存在**。评分 4/5 → 5/5 |
| **C3 重新定义** | v5.0 已移除 Trailing Stop，C3 从 "Trailing 协同" 改为 "S/R 替代 Trailing 充分性"。评分 4/5 → 3/5 |
| **F5 描述更新** | L4829 检查减仓量 ≥ min_trade_amount，但未检查**剩余量** (target_qty)。部分实现 |
| **A 模块总分** | 4.0 → 4.1 (A10 bug 消除，风控安全性上调) |
| **C 模块总分** | 3.5 → 3.2 (Trailing 移除，结构/学术/风控维度下调) |
| **加权总分** | 4.0 → 3.9 |
| **问题清单调整** | 移除 P1 #9 "A10 Bid Wall bug"；更新 P2 #19 C3 描述 |

### v2.0 变更日志

| 变更 | 说明 |
|------|------|
| **A11-A12 新增** | S/R Flip 检测、Zone 时序稳定性 |
| **A3 评分调整** | 4/5 → 3.5/5 (跨时间框架 Pivot 叠加问题) |
| **B11-B12 新增** | Emergency SL 合理性、Measured Move 跨市场验证 |
| **B4 评分调整** | 4/5 → 3.5/5 (ATR=0 fallback 使用固定百分比) |
| **C11-C12 新增** | TP 单向保护、Breakeven Stop |
| **C3 评分调整** | 5/5 → 4/5 (Trailing 协同边界情况未测试) |
| **E9 新增** | 加仓后加权均价 R/R 重算 |
| **F9 新增** | 分阶梯自动止盈 |
| **综合评分重算** | 加权总分 4.2 → 4.0 (新增标准暴露更多缺陷) |

---

## 目录

1. [评价标准总表](#一评价标准总表)
2. [A — S/R Zone 有效性评估](#a--sr-zone-有效性评估)
3. [B — 首次止盈止损设置](#b--首次止盈止损设置-开仓-sltp)
4. [C — 动态止盈止损设置](#c--动态止盈止损设置-持仓中-sltp-调整)
5. [D — 开仓](#d--开仓)
6. [E — 加仓](#e--加仓)
7. [F — 减仓](#f--减仓)
8. [G — 平仓](#g--平仓)
9. [综合评分 & 关键问题清单](#综合评分--关键问题清单)

---

## 一、评价标准总表

每项操作按以下 5 个维度打分（1-5 分），权重见括号：

| 维度 | 权重 | 说明 |
|------|------|------|
| **结构完整性** (25%) | Structure | 逻辑是否完整、无遗漏路径、边界条件覆盖 |
| **学术/行业依据** (20%) | Evidence | 算法是否有学术论文或行业最佳实践支撑 |
| **风控安全性** (25%) | Safety | 最坏情况下是否仍能保护资金、无裸仓可能 |
| **实用合理性** (20%) | Practicality | 参数是否适应真实市场、不过度理想化 |
| **代码健壮性** (10%) | Robustness | 错误隔离、降级、日志、通知是否完善 |

**评分标准：**
- 5 = 业界领先，无明显改进空间
- 4 = 成熟可靠，有小幅改进空间
- 3 = 基本可用，有明显但非致命的问题
- 2 = 有重要缺陷，需要修复才能生产使用
- 1 = 存在致命缺陷，可能造成资金损失

---

## A — S/R Zone 有效性评估

### A.1 评价标准

| # | 标准 | 达标定义 |
|---|------|---------|
| A1 | **多源融合** | S/R 来自 ≥3 种独立数据源（Swing + Pivot + VP + OrderWall + 心理位） |
| A2 | **学术基础** | 每种检测方法有论文/统计依据 |
| A3 | **聚合去重** | 同价位多候选正确聚类，权重不双重计算 |
| A4 | **质量分级** | HIGH/MEDIUM/LOW 分级有客观量化门槛 |
| A5 | **时间衰减** | 老旧 S/R 权重递减，反映市场记忆衰退 |
| A6 | **触及次数** | 2-3 次触及最优（Osler 2000），4+ 次递减 |
| A7 | **PROJECTED 限制** | 纯数学投射（Pivot）不应获得 HIGH 评级 |
| A8 | **ATR 自适应** | 聚类阈值随波动率动态调整，非固定百分比 |
| A9 | **成交量确认** | 有 Volume Profile 或成交量加权验证 |
| A10 | **异常过滤** | Order Wall 有最小阈值、心理位有合理步长 |
| A11 | **S/R Flip 检测** | 突破阻力后该价位转为支撑（反之亦然），且权重合理调整 |
| A12 | **Zone 时序稳定性** | 相邻两次计算的 S/R zones 偏移可控，避免频繁 SL/TP 抖动 |

### A.2 现状评估

| # | 现状 | 评分 | 说明 |
|---|------|------|------|
| A1 | ✅ 5 种数据源 | 5/5 | Swing (Williams Fractal) + Pivot (Floor Trader) + VP (VPOC/VAH/VAL) + Order Wall + Round Number |
| A2 | ✅ 引用充分 | 4/5 | Osler (2003) 心理位、Spitsin (2025) 成交量加权、Chan (2022) Swing、CME Market Profile。Pivot 缺乏专门引用 |
| A3 | ✅ ATR 聚类 + 同源上限 | 3.5/5 | `same_data_weight_cap=2.5`, `total_cap=6.0`, 多源 bonus +0.2/+0.5。**问题**: 相同价位的 Daily Pivot R1 和 Weekly Pivot S1 可能叠加到 2.2 而非应被识别为同一投射。跨时间框架 Pivot 本质上都是 PROJECTED 来源，应共享同源上限而非分别计算 |
| A4 | ✅ 量化门槛 | 4/5 | HIGH ≥ 3.0 权重 或 Order Wall ≥ 100 BTC；MEDIUM ≥ 1.5。**问题**: 门槛是经验值，无回测验证 |
| A5 | ✅ age_factor | 3/5 | `max(0.5, 1.0 - bars_ago/max_age * 0.5)`。**问题**: 最低只衰减到 50%，100 根 K 线前的 Swing 仍保留一半权重，可能过于保守 |
| A6 | ✅ Osler 递减 | 5/5 | 2-3 次 +0.5 bonus, 4+ 次递减 `max(0.0, 0.5-(count-4+1)*0.2)`，精确匹配 Osler (2000) 研究 |
| A7 | ✅ PROJECTED cap | 5/5 | Pivot 点强制 MEDIUM 上限，即使权重达到 HIGH 也被限制 |
| A8 | ✅ ATR 自适应 | 4/5 | `atr_cluster_multiplier=0.5`, 范围 `[0.1%, 2.0%]`。**问题**: ATR 计算用简单 SMA(14) 而非 Wilder 平滑，略高估 |
| A9 | ✅ VP + 成交量加权 | 4/5 | VP 提供 VPOC/VAH/VAL；Swing 有 Spitsin 连续百分位加权。**问题**: VP 最低 10 根 K 线即可触发（仅 2.5 小时），样本不足 |
| A10 | ✅ 多重过滤 | 5/5 | Order Wall ≥ 50 BTC + 距离 ≥ 0.5%；Round Number 步长 $5000。**v2.1 审计确认**: L898 `wall_price >= current_price → skip` (bid walls 必须在价格下方=支撑) + L936 `wall_price <= current_price → skip` (ask walls 必须在价格上方=阻力)，方向过滤逻辑**正确无误** |
| A11 | ✅ S/R Flip 实现 | 4/5 | `sr_zone_calculator.py` L340-375 实现 Swing 突破检测：被突破的阻力标记为新支撑。**v2.1 审计**: Flip 后创建新 SRCandidate (非修改旧 candidate)，触及计数**不继承** (新 candidate 初始 touch=0)，时间衰减从 bars_ago 重新计算。**问题**: 翻转后权重仅由 `WEIGHTS['Swing_High'] × age_factor` 决定，缺少翻转信心折扣 (翻转 zone 未经新方向多次验证) |
| A12 | ⚠️ 无显式稳定性保证 | 3/5 | ATR 聚类天然提供一定稳定性（同 zone 内的微小变化会被聚合）。**问题**: 新 bar 进入可能导致 Swing 点出现/消失，VP 分布位移，引起 zone 列表抖动。无显式的 "zone 粘性" 或最小变化阈值来防止连续周期输出不同 zone 集合 |

### A.3 S/R 评估综合评分

| 维度 | 评分 | 理由 |
|------|------|------|
| 结构完整性 | 4.0/5 | 5 源融合 + 聚类 + 分级 + 触及计数覆盖全面；S/R Flip 已实现但权重继承不透明；zone 稳定性无显式保证 |
| 学术依据 | 4.5/5 | Osler, Spitsin, Chan, CME 四大引用支撑；S/R Flip 有 Magee (2001) 支持 |
| 风控安全性 | 4.5/5 | PROJECTED cap、同源上限防过度权重；**v2.1**: Order Wall 方向过滤已审计确认正确 |
| 实用合理性 | 3.0/5 | VP 最低样本量偏低；时间衰减最低 50% 过于保守；ATR 精度待提升；zone 抖动可能导致下游 SL/TP 频繁调整 |
| 代码健壮性 | 4.5/5 | 每层 try/except 隔离；降级到中性值；日志完善 |

**S/R Zone 总分: 4.1 / 5.0** (v2.0: 4.0, v1.0: 4.2)

### A.4 关键改进建议

| 优先级 | 问题 | 建议 |
|--------|------|------|
| ~~**P1**~~ | ~~A10: Bid Wall 方向过滤疑似 bug~~ | **v2.1 审计已确认: 代码逻辑正确，无需修复** |
| **P1** | A11: Flip 权重缺少翻转信心折扣 | 翻转后添加 0.5× 折扣因子 (翻转 zone 未经新方向多次验证)，触及计数已确认不继承 |
| **P2** | A12: Zone 抖动 | 添加 zone 粘性: 如果新旧 zone 中心价差 < ATR×0.2，保留旧 zone（防止下游 SL/TP 微调风暴） |
| **P2** | A9: VP 最低 10 根 K 线过少 | 提升到 48 根 (12 小时最低) |
| **P2** | A8: ATR 用 SMA 非 Wilder 平滑 | 改用 Wilder 指数平滑 |
| **P2** | A5: 时间衰减最低 50% 过于保守 | 改为 `max(0.3, ...)` 或引入指数衰减 |

---

## B — 首次止盈止损设置 (开仓 SL/TP)

### B.1 评价标准

| # | 标准 | 达标定义 |
|---|------|---------|
| B1 | **SL 锚定于 S/R** | SL 必须锚定在已确认的 S/R zone，不允许任意百分比 |
| B2 | **TP 锚定于 S/R** | TP 优先使用对侧 S/R zone，次选 Measured Move |
| B3 | **R/R 硬门槛** | R/R < 1.5:1 时拒绝交易，不降级为百分比兜底 |
| B4 | **ATR 缓冲** | SL 在 zone 外侧加 ATR 缓冲，防止假突破触发 |
| B5 | **多层验证** | AI SL/TP → S/R SL/TP → 拒绝，三层递进 |
| B6 | **方向安全** | LONG SL < entry < TP; SHORT TP < entry < SL |
| B7 | **最小距离** | SL 距入场价 ≥ 1%，防噪声止损 |
| B8 | **滑点补偿** | 成交后按真实成交价重新验证 R/R |
| B9 | **SL 锚点质量评分** | SL 选择基于多因子评分，非仅距离最近 |
| B10 | **无 zone 时拒绝** | 当方向上无 S/R zone 时直接拒绝，不伪造 SL/TP |
| B11 | **Emergency SL 合理性** | SL 提交失败时的紧急止损应基于 ATR 而非固定百分比，保持与 S/R 哲学一致 |
| B12 | **Measured Move 跨市场验证** | Measured Move 命中率需在交易品种 (加密货币) 上回测验证，不仅依赖股票市场统计 |

### B.2 现状评估

| # | 现状 | 评分 | 说明 |
|---|------|------|------|
| B1 | ✅ v4.3 强制 | 5/5 | `_select_sl_anchor()` 多因子评分选 zone；无 zone → return None |
| B2 | ✅ S/R + Measured Move | 4/5 | TP 候选按质量排序遍历；Measured Move 作为第二路径 (Bulkowski 2021: 85%)。**问题**: Measured Move 本质是投射，未经本品种回测验证命中率 |
| B3 | ✅ v4.3 硬门槛 | 5/5 | `min_rr_ratio=1.5` 在 `calculate_sr_based_sltp()` 和 `validate_multiagent_sltp()` 双重执行 |
| B4 | ✅ ATR buffer | 3.5/5 | `sl = anchor ± ATR × 0.5`。**问题**: ATR=0 时回退到 `price × 0.5%`——虽然罕见，但这是固定百分比兜底，与 "S/R-only" 哲学矛盾。应使用最近 N 根 K 线的 True Range 均值作为 ATR 估算 |
| B5 | ✅ 三层递进 | 5/5 | AI SL/TP (validate_multiagent_sltp) → S/R (calculate_sr_based_sltp) → 拒绝 (return None) |
| B6 | ✅ 方向验证 | 5/5 | `validate_multiagent_sltp()` 和 `calculate_sr_based_sltp()` 均检查方向合法性 |
| B7 | ✅ 1% 最小距离 | 5/5 | `min_sl_distance_pct=1%` 在 `validate_multiagent_sltp()` 中执行 |
| B8 | ✅ Post-fill R/R | 5/5 | `_validate_and_adjust_rr_post_fill()` 在 `on_position_opened()` 后按真实成交价重算，R/R 不足时调整 TP |
| B9 | ✅ 多因子评分 | 5/5 | `score = strength×10 + quality×5 + touch×3 + swing×2 + proximity`，综合质量排序 |
| B10 | ✅ v4.3 拒绝 | 5/5 | SL 无 zone → `(None, None, reason)`；TP 无 zone → `(None, None, reason)` |
| B11 | ⚠️ 固定 2% | 3/5 | `_submit_emergency_sl(2%)` 使用固定百分比。**问题**: Emergency SL 的存在是正确的安全网，但 2% 固定值在高波动环境可能不足 (ATR > 2%)，低波动环境又过宽。应使用 `max(2%, ATR × 1.5)` |
| B12 | ⚠️ 未验证 | 3/5 | Bulkowski (2021) 85% 命中率基于股票市场 (S&P 500)。**问题**: 加密货币市场波动率更高、趋势特征不同，Measured Move 命中率可能显著偏低。建议添加 BTC/ETH 历史数据回测，或者在 Measured Move 路径上要求 R/R ≥ 2.0:1 (高于标准 1.5:1) 作为安全裕度 |

### B.3 首次 SL/TP 综合评分

| 维度 | 评分 | 理由 |
|------|------|------|
| 结构完整性 | 4.5/5 | 三层递进 + R/R 硬门槛 + Post-fill 补偿 + 无 zone 拒绝，覆盖所有路径；Emergency SL 和 Measured Move 作为最后防线存在但精度不足 |
| 学术依据 | 3.5/5 | Bulkowski Measured Move、Osler S/R 触及、ATR 缓冲均有依据；但 Measured Move 未在加密市场回测验证，学术支撑不完整 |
| 风控安全性 | 4.5/5 | v4.3 消除了所有百分比兜底（主路径），S/R veto is final；Emergency SL 使用固定 % 是安全网的合理妥协但可优化 |
| 实用合理性 | 4.0/5 | R/R ≥ 1.5 可能在低波动市场频繁拒绝交易 (过度保守换安全性，合理取舍) |
| 代码健壮性 | 4.5/5 | ATR=0 有回退；Post-fill 有降级；SL 提交失败有 emergency SL |

**首次 SL/TP 总分: 4.2 / 5.0** (v1.0: 4.6)

### B.4 关键改进建议

| 优先级 | 问题 | 建议 |
|--------|------|------|
| **P1** | B11: Emergency SL 固定 2% | 改为 `max(2%, ATR × 1.5)`，在 ATR 可用时使用动态值 |
| **P2** | B12: Measured Move 未验证 | 在 Measured Move 路径上要求 R/R ≥ 2.0:1 (高于标准 1.5)；或添加 BTC 历史回测验证 |
| **P2** | B4: ATR=0 回退 | 改用最近 N 根 K 线的 True Range 均值，而非固定 0.5% |

---

## C — 动态止盈止损设置 (持仓中 SL/TP 调整)

### C.1 评价标准

| # | 标准 | 达标定义 |
|---|------|---------|
| C1 | **周期性重评估** | 每个分析周期（15分钟）基于最新 S/R zones 重新计算 |
| C2 | **单向保护** | SL 只能向有利方向移动 (LONG: 只升不降; SHORT: 只降不升) |
| C3 | **S/R 替代 Trailing 充分性** | v5.0 移除 Trailing Stop 后，S/R 动态重评估应能充分替代 Trailing 的核心功能 (持续跟踪价格移动、锁定浮盈) |
| C4 | **显著性过滤** | 微小调整 (< 0.1%) 不触发订单操作，避免频繁取消重建 |
| C5 | **失败不降级** | S/R 重评估失败时保留旧 SL，不回退到百分比 |
| C6 | **事件驱动** | 在 on_timer 中执行，按固定周期触发 |
| C7 | **通知机制** | SL/TP 变更时通知用户，失败时告警 |
| C8 | **TP 也更新** | TP 也基于最新 S/R 重新计算，不仅限 SL |
| C9 | **市场 regime 感知** | Trending 市场允许更宽 SL，Ranging 市场更紧 |
| C10 | **避免订单风暴** | 同一周期内只产生一次 SL/TP 操作 |
| C11 | **TP 单向保护** | TP 只能向更有利方向移动 (LONG: 只升不降; SHORT: 只降不升)，防止盈利目标缩小 |
| C12 | **Breakeven Stop** | 浮盈达到一定阈值 (如 1×ATR) 时，可选将 SL 移到入场价 (保本)，独立于 S/R 和 Trailing |

### C.2 现状评估

| # | 现状 | 评分 | 说明 |
|---|------|------|------|
| C1 | ✅ 每 15 分钟 | 4/5 | `_reevaluate_sltp_for_existing_position()` 在 on_timer 中调用。**问题**: 固定周期，不感知急速行情 |
| C2 | ✅ 单向保护 | 5/5 | LONG: `final_SL = max(new_SL, old_SL)`; SHORT: `final_SL = min(new_SL, old_SL)` |
| C3 | ⚠️ 部分替代 | 3/5 | **v2.1 审计**: v5.0 已完全移除 Trailing Stop，S/R 动态重评估是唯一 SL 调整机制。**优势**: SL 锚定在结构性 S/R zone (比固定百分比跟踪更有意义)。**缺陷**: S/R 重评估每 15 分钟一次，无法像 Trailing 那样连续跟踪价格移动。在 S/R zone 稀疏区间，SL 可能长时间不更新，浮盈无法及时锁定。需要 C12 Breakeven Stop 作为补充 |
| C4 | ✅ 0.1% 过滤 | 5/5 | 变化 < 0.1% 跳过，避免订单频繁取消重建 |
| C5 | ✅ 保留旧 SL | 4/5 | 返回 None 时保留旧 SL + 发送告警。**问题**: 告警有 15 分钟冷却——如果连续 3 次失败，用户只收到 1 次通知 |
| C6 | ✅ 事件驱动 | 5/5 | `_reevaluate_sltp_for_existing_position()` 在 on_timer 中执行，一个周期只一次操作 |
| C7 | ✅ 通知 + 告警 | 4/5 | 变更时 Telegram 通知；失败时 WARNING 告警（15 分钟冷却） |
| C8 | ✅ TP 也更新 | 4/5 | `calculate_sr_based_sltp()` 同时返回 SL 和 TP。**问题**: TP 更新没有"只向有利方向"的限制——可能 TP 向下调整缩小盈利空间 |
| C9 | ⚠️ 隐式 regime 适应 | 3.5/5 | **v2.2 审计修正**: 系统已有两层隐式 regime 适应: (1) **机械层**: ATR buffer (`SL = anchor ± ATR × 0.5`) 天然随波动率缩放——trending 市场 ATR 大 → SL 自动更宽，ranging 市场 ATR 小 → SL 自动更紧；(2) **AI 层**: `INDICATOR_DEFINITIONS` 教导 AI 完整 regime 检测 (ADX >25+方向=TRENDING, ADX <20+振荡=RANGING, BB squeeze 等)，AI 在选择 SL/TP 时已考虑 regime。**不添加硬编码 ADX 规则**: 违反 TradingAgents 原则 "Autonomy is non-negotiable" (multi_agent_analyzer.py L1104)。**残留问题**: 无显式日志记录当前 regime 状态，难以审计 AI 是否真正利用了 regime 信息 |
| C10 | ✅ 一次操作 | 5/5 | `_reevaluate` 设计确保同一周期最多一次 cancel+recreate |
| C11 | ❌ 未实现 | 2/5 | **问题**: TP 可双向移动。LONG 持仓中，如果新 S/R 重评估返回更低的 TP (如阻力位下移)，TP 会被下调。**v2.2 AI/本地职责审查**: 与 SL 单向保护 (C2) 不同——SL 单向是**安全性**需求 (LOCAL 职责)，TP 单向是**优化**需求。强制 `max(new_TP, old_TP)` 会保留无 S/R 结构支撑的过时 TP (zone 已偏移)，违反 S/R 哲学。**建议重新定义**: 此项应由 AI 在重评估时自主决定 TP 方向，而非 LOCAL 硬编码 |
| C12 | ❌ 未实现 | 2/5 | **问题**: 无 Breakeven Stop 机制。**v2.2 AI/本地职责审查**: 入场价 (entry price) 是个人交易价格，**不是市场结构** (S/R zone)。在 S/R 系统中，SL 应始终锚定于有市场意义的结构价位。Breakeven Stop 本质是心理工具 (Van Tharp)，而非结构工具。**哲学矛盾**: 如果 S/R zone 在入场价之下，C2 单向保护 + S/R 重评估已足够锁定浮盈；如果 S/R zone 在入场价之上，Breakeven 会被 C2 覆盖。**建议重新定义**: 仅在 S/R zone 极度稀疏时作为补充，优先级低于 C3 事件驱动重评估 |

### C.3 动态 SL/TP 综合评分

| 维度 | 评分 | 理由 |
|------|------|------|
| 结构完整性 | 3.2/5 | SL 单向保护 + 显著性过滤完整；**v2.2**: ATR buffer 提供隐式 regime 适应 (C9 确认)；**仍缺**: TP 方向保护机制 (C11 需重新定义为 AI 职责)、S/R 稀疏区间浮盈锁定 (C3 事件驱动可补充) |
| 学术依据 | 2.8/5 | **v2.2**: ATR 隐式 regime 适应有统计学基础 (波动率聚类效应)；AI regime 检测通过 INDICATOR_DEFINITIONS 传递 ADX/BB 数据 → AI 自主利用。Trailing 文献不再适用；Breakeven 有 Van Tharp 支持但与 S/R 哲学矛盾 |
| 风控安全性 | 3.7/5 | SL 只升不降保证安全；失败保留旧 SL；**v2.2**: ATR buffer 自动缩放提供隐式 regime 安全性 (trending 时 SL 更宽避免假突破)；TP 方向问题需 AI 自主管理 |
| 实用合理性 | 3.2/5 | 固定 15 分钟周期在急速行情中响应不足；**v2.2**: ATR 已提供实用的 regime 适应 (无需额外 ADX 硬编码)；C11/C12 需重新定义而非简单实现 |
| 代码健壮性 | 4.5/5 | try/except 隔离、降级日志、通知冷却完善 |

**动态 SL/TP 总分: 3.4 / 5.0** (v2.1: 3.2, v2.0: 3.5, v1.0: 3.9)

### C.4 关键改进建议

| 优先级 | 问题 | 建议 |
|--------|------|------|
| ~~**P0**~~ | ~~C9: 无 regime 感知~~ | **v2.2 审计已确认: ATR buffer 隐式 regime 适应 + AI ADX/regime 数据已提供。降级 P2** |
| **P1** | C11: TP 可向不利方向调整 | **v2.2 职责审查**: SL 单向=安全性 (LOCAL)，TP 单向=优化 (应为 AI 职责)。硬编码 `max(new_TP, old_TP)` 会保留无 S/R 支撑的过时 TP。**建议**: 交由 AI 在重评估时自主决定；若实现 LOCAL 保护，需同时验证旧 TP 仍有 S/R zone 支撑 |
| **P1** | C12: 无 Breakeven Stop | **v2.2 职责审查**: 入场价非市场结构，与 S/R 哲学矛盾。仅在 S/R zone 极度稀疏时作为补充。**建议**: 优先级低于 C1 事件驱动重评估和 C3 S/R 连续覆盖改进 |
| **P2** | C1: 固定周期 | 在 `on_bar()` 中检测价格突破 S/R zone 时触发即时重评估 (事件驱动补充) |
| **P2** | C3: S/R 替代 Trailing 不完整 | S/R 每 15 分钟重评估无法替代 Trailing 的连续跟踪。需结合 C12 Breakeven Stop 和 C1 事件驱动重评估来弥补 |

---

## D — 开仓

### D.1 评价标准

| # | 标准 | 达标定义 |
|---|------|---------|
| D1 | **SL/TP 先验证** | 先验证 SL/TP 有效，再提交入场单 (无保护不开仓) |
| D2 | **两阶段提交** | Entry → 成交后 → SL/TP 分别提交 (适配 NT 1.222.0) |
| D3 | **R/R 门槛** | R/R < 1.5:1 拒绝开仓 |
| D4 | **Regime 过滤** | 1D 趋势层 (SMA200 + ADX) 作为宏观过滤器 |
| D5 | **仓位大小合理** | AI 控制 + R/R 关联 + 最小 notional 校验 |
| D6 | **SL 提交失败保护** | Entry 成功但 SL 提交失败时有 emergency SL |
| D7 | **成交价验证** | MARKET 单滑点后重新验证 R/R |
| D8 | **状态一致性** | 无悬空状态（pending_sltp 超时清理） |
| D9 | **并发安全** | 不在上一个订单未完成时提交新订单 |
| D10 | **通知完整** | 入场通知包含：方向、价格、SL、TP、R/R、仓位、信心 |

### D.2 现状评估

| # | 现状 | 评分 | 说明 |
|---|------|------|------|
| D1 | ✅ SL/TP 先验证 | 5/5 | `_validate_sltp_for_entry()` 在 `_submit_bracket_order()` 之前。验证失败 → 不开仓 |
| D2 | ✅ 两阶段 | 5/5 | v4.17: LIMIT entry @ validated price → `_pending_sltp` → `on_position_opened()` → 分别提交 SL + TP |
| D3 | ✅ R/R 硬门槛 | 5/5 | `validate_multiagent_sltp()` + `calculate_sr_based_sltp()` 双重 R/R ≥ 1.5 |
| D4 | ✅ 趋势过滤 | 4/5 | MTF 三层架构: 1D → 4H → 15M。**问题**: `require_above_sma` 是配置项，可被关闭 |
| D5 | ✅ AI 控制仓位 | 4/5 | v4.8: AI 提供 `position_size_pct` + R/R 关联表 (≥2.5:1→80%, ≥2.0→50%, ≥1.5→30%)。**问题**: AI 可能忽略 prompt 指导给出不合理 pct |
| D6 | ✅ Emergency SL | 5/5 | `on_position_opened()` 中 SL 提交失败 → `_submit_emergency_sl(2%)` + CRITICAL 告警 |
| D7 | ✅ Post-fill R/R | 5/5 | `_validate_and_adjust_rr_post_fill()` 按实际成交价调整 TP |
| D8 | ✅ 超时清理 | 4/5 | `_pending_sltp` 有超时机制。**问题**: 超时时间是否足够长取决于 Binance API 延迟 |
| D9 | ✅ 状态检查 | 4/5 | 检查现有持仓后决定开仓/加仓/反转。**问题**: 极端高频信号下理论上可能出现竞态 |
| D10 | ✅ 完整通知 | 5/5 | 统一 Telegram 通知包含方向、价格、SL、TP、R/R、仓位、信心、S/R zone 依据 |

### D.3 开仓综合评分

| 维度 | 评分 | 理由 |
|------|------|------|
| 结构完整性 | 5.0/5 | 验证→入场→成交→SL/TP→Post-fill 全链路覆盖 |
| 学术依据 | 4.0/5 | R/R 门槛、趋势过滤有大量文献；两阶段提交是工程实践 |
| 风控安全性 | 5.0/5 | 无保护不开仓 + emergency SL + Post-fill R/R + CRITICAL 告警 |
| 实用合理性 | 4.5/5 | 两阶段提交适配 NT 1.222.0 限制；R/R 可能过于严格 |
| 代码健壮性 | 4.5/5 | 完善的状态管理、超时清理、错误通知 |

**开仓总分: 4.6 / 5.0** (v1.0: 4.6, 未变化)

---

## E — 加仓

### E.1 评价标准

| # | 标准 | 达标定义 |
|---|------|---------|
| E1 | **当前价 R/R 验证** | 以当前价格（非原入场价）重新验证 R/R |
| E2 | **SL/TP 全量替换** | 加仓后取消旧 SL/TP，按新仓位量 + 新价格重建 |
| E3 | **数量正确性** | 新 SL/TP 数量 = 总持仓量（原仓 + 新仓） |
| E4 | **最小加仓量** | 有最小加仓阈值，避免微量加仓产生不必要的订单操作 |
| E5 | **加仓上限** | 有最大持仓限制，防止无限金字塔 |
| E6 | **同方向确认** | 只在信号方向与持仓方向一致时加仓 |
| E7 | **加仓信心门槛** | 加仓需要一定信心等级 |
| E8 | **加仓后通知** | 通知包含加仓量、新均价、新 SL/TP |
| E9 | **加权均价 R/R 重算** | 加仓后以加权平均入场价 (非最新入场价) 重新验证 R/R 和 SL/TP 合理性 |

### E.2 现状评估

| # | 现状 | 评分 | 说明 |
|---|------|------|------|
| E1 | ✅ 当前价 R/R | 5/5 | v4.11: `_validate_sltp_for_entry(side, confidence)` 用当前价格重新验证 |
| E2 | ✅ 全量替换 | 5/5 | `_replace_sltp_orders()` 取消全部旧单 → 重建新 SL/TP |
| E3 | ✅ 总持仓量 | 5/5 | 新 SL/TP 数量 = position.quantity (总持仓) |
| E4 | ✅ 最小阈值 | 4/5 | `adjustment_threshold = 0.01 BTC`。**问题**: 固定值不随仓位比例变化 (10 BTC 持仓加 0.01 = 0.1% 变化也会触发) |
| E5 | ✅ 累积 30% 硬限 | 4/5 | **v2.2 审计修正**: L3335-3360 已实现累积仓位上限: `max_usdt = equity × max_position_ratio × leverage` (如 $1000×0.30×5=$1500)，`remaining_capacity = max_usdt - current_value`。当 `remaining_capacity ≤ 0` 时**拒绝加仓** (return 0.0)；否则 cap 加仓量到 remaining_capacity。`position_sizing_cumulative: bool = True` (L77 默认启用)。**残留问题**: `max_position_ratio=0.30` 是配置值，无代码级硬性上限 (如 absolute max 50%) 防止配置错误 |
| E6 | ✅ 同方向 | 5/5 | `_manage_existing_position()` 路由: 同方向 + size_diff > 0 → ADD 路径 |
| E7 | ⚠️ 隐式门槛 | 3/5 | 通过 R/R 和 AI 信心间接限制，但无专门的"加仓信心必须 ≥ MEDIUM"硬性规则 |
| E8 | ✅ 通知完整 | 5/5 | Telegram "scaling ADD" 通知包含新增量、总持仓、新 SL/TP |
| E9 | ⚠️ 偏保守设计 | 3/5 | **v2.2 审计修正**: 代码使用**当前市场价** (非加权均价) 计算 R/R。这实际上**偏保守** (高估风险)，不是低估。示例: 原仓 $95k (0.1 BTC) + 加仓 $96k (0.05 BTC)，加权均价≈$95,333。基于 $96k 计算的 R/R 比基于 $95,333 更严格。**真正问题**: 可能过度拒绝合理加仓 (R/R 从均价看满足 1.5:1，但从当前价看不满足 → 误拒)。**安全方向错误**: 偏保守 (过度拒绝) 而非偏激进 (风险低估)。P0 → P2 |

### E.3 加仓综合评分

| 维度 | 评分 | 理由 |
|------|------|------|
| 结构完整性 | 4.0/5 | **v2.2**: R/R 验证 + SL/TP 全量替换 + 累积 30% 上限完整；缺专门信心门槛 (E7) |
| 学术依据 | 3.0/5 | 金字塔加仓有大量文献，但实现未引用如 Van Tharp 等仓位管理理论 |
| 风控安全性 | 3.5/5 | **v2.2**: 累积 30% 硬限确认存在 (E5)，非无限加仓；R/R 用当前价偏保守 (E9) 安全方向正确；缺 max_position_ratio 代码级上限 |
| 实用合理性 | 3.5/5 | **v2.2**: R/R 重新验证实用；累积限制防止过度杠杆；当前价 R/R 可能过度拒绝合理加仓 (E9 效率损失) |
| 代码健壮性 | 4.5/5 | 全量替换逻辑清晰，SL 失败有 emergency 保护 |

**加仓总分: 3.6 / 5.0** (v2.1: 3.2, v1.0: 3.5)

### E.4 关键改进建议

| 优先级 | 问题 | 建议 |
|--------|------|------|
| ~~**P0**~~ | ~~E5: 无加仓上限~~ | **v2.2 审计已确认: L3335-3360 累积 30% 硬限已实现。已关闭** |
| ~~**P0**~~ | ~~E9: 无加权均价 R/R~~ | **v2.2 审计修正: 当前价 R/R 偏保守 (安全方向正确)。降级 P2 (效率优化)** |
| **P1** | E7: 无专门信心门槛 | 添加 `min_confidence_to_add: MEDIUM`，LOW 信心不加仓 |
| **P2** | E4: 固定加仓阈值 | 改为比例阈值: `adjustment_threshold = max(0.01, current_qty × 5%)` |

---

## F — 减仓

### F.1 评价标准

| # | 标准 | 达标定义 |
|---|------|---------|
| F1 | **先取消旧 SL/TP** | 减仓前先取消旧 SL/TP（数量不匹配会被交易所拒绝） |
| F2 | **事件驱动重建** | 减仓成交后重建新数量的 SL/TP |
| F3 | **SL/TP 价格保留** | 减仓只改数量，SL/TP 价格不变（除非有更好价位） |
| F4 | **数量匹配验证** | 新 SL/TP 数量 = 减仓后的剩余持仓量 |
| F5 | **最小剩余量** | 剩余仓位 < 最小交易量时应全平而非留零碎 |
| F6 | **超时清理** | 减仓状态有超时，防止悬空 |
| F7 | **reduce_only 标记** | 减仓订单标记 reduce_only，防止误开反向仓位 |
| F8 | **减仓通知** | 通知包含减仓量、剩余量、原因 |
| F9 | **分阶梯自动止盈** | 支持自动分批止盈策略 (如 50% at R1, 50% at R2)，减仓不仅由 AI 信号驱动 |

### F.2 现状评估

| # | 现状 | 评分 | 说明 |
|---|------|------|------|
| F1 | ✅ 先取消 | 5/5 | `_manage_existing_position()` REDUCE 路径先 cancel ALL existing SL/TP |
| F2 | ✅ 事件驱动 | 5/5 | `on_position_changed()` 检测 `_pending_reduce_sltp` → 数量匹配后重建 |
| F3 | ✅ 价格保留 | 5/5 | `_pending_reduce_sltp` 存储 `old_sl/old_tp` 价格，重建时复用 |
| F4 | ✅ 数量匹配 | 4/5 | 5% 容差匹配: `abs(actual_qty - expected_qty) / expected_qty < 0.05`。**问题**: 容差较宽，可能掩盖真实数量问题 |
| F5 | ⚠️ 部分实现 | 3/5 | **v2.1 审计**: L4829-4840 检查 `reduce_qty < min_trade_amount` → 跳过减仓。但这检查的是**减仓量**而非**剩余量** (target_qty)。**问题**: 当 target_qty < Binance minimum notional 时，减仓仍会执行，剩余量过小导致后续 SL/TP 重建被交易所拒绝 → 裸仓 |
| F6 | ✅ 60 秒超时 | 5/5 | `on_position_changed()` 检查 `elapsed > 60` → 清理 `_pending_reduce_sltp` |
| F7 | ✅ reduce_only | 5/5 | 减仓订单使用 `reduce_only=True`，防止误开反向 |
| F8 | ✅ 通知 | 4/5 | Telegram 通知减仓操作。细节程度较简洁 |
| F9 | ❌ 未实现 | 2/5 | **问题**: 当前系统只支持单一 TP (整体止盈) 和手动 `/partial_close`。无自动分阶梯止盈功能。当持仓面临两个 S/R 阻力位 (如 R1=$98000, R2=$100000) 时，无法自动在 R1 平 50% + R2 平 50%。Elder "三屏系统" 和 Van Tharp 均推荐分批止盈以锁定部分利润同时保留趋势收益 |

### F.3 减仓综合评分

| 维度 | 评分 | 理由 |
|------|------|------|
| 结构完整性 | 3.5/5 | 事件驱动重建 + 超时清理完整；缺最小剩余量保护和分阶梯止盈 |
| 学术依据 | 3.0/5 | 减仓是标准风控实践；分阶梯止盈有 Elder 三屏系统等文献支持但未实现 |
| 风控安全性 | 4.0/5 | reduce_only + 价格保留 + 超时清理安全；5% 容差和最小剩余量有风险 |
| 实用合理性 | 3.5/5 | 事件驱动方式可靠；缺少自动分批止盈在实际交易中损失了部分盈利优化机会 |
| 代码健壮性 | 4.5/5 | 超时、状态清理、cancel→reduce→rebuild 链路完整 |

**减仓总分: 3.6 / 5.0** (v1.0: 3.9)

### F.4 关键改进建议

| 优先级 | 问题 | 建议 |
|--------|------|------|
| **P1** | F5: 无最小剩余量 | 减仓前检查: `remaining_qty < min_trade_amount` → 转为全平 (CLOSE) |
| **P1** | F9: 无分阶梯止盈 | 实现 multi-TP 策略: `tp_levels: [{pct: 50, target: "R1"}, {pct: 50, target: "R2"}]`。第一个 TP 触发后自动减仓 + 重建剩余 SL/TP |
| **P2** | F4: 5% 容差过宽 | 收紧到 2% 或与 Binance 精度对齐 |

---

## G — 平仓

### G.1 评价标准

| # | 标准 | 达标定义 |
|---|------|---------|
| G1 | **触发多样性** | SL 触发 / TP 触发 / AI CLOSE 信号 / 手动 /close 命令 均支持 |
| G2 | **OCO 联动** | SL 成交 → 自动取消 TP；TP 成交 → 自动取消 SL |
| G3 | **反转两阶段** | 反向信号时: 先平仓 → on_position_closed → 再开仓（不同时提交） |
| G4 | **状态清理** | 平仓后清理: trailing_stop_state, pending_sltp, pending_reversal, oco 记录 |
| G5 | **孤儿订单处理** | 平仓后残留的 SL/TP 挂单被识别并取消 |
| G6 | **反转信心门槛** | 反转需 HIGH 信心（可配置） |
| G7 | **并发安全** | 平仓过程中不接受新开仓信号 |
| G8 | **平仓通知** | 通知包含: 盈亏、持仓时间、触发原因 |

### G.2 现状评估

| # | 现状 | 评分 | 说明 |
|---|------|------|------|
| G1 | ✅ 多触发源 | 5/5 | SL/TP 自动触发 + AI CLOSE 信号 + Telegram `/close` + `/partial_close` |
| G2 | ✅ OCO 联动 | 5/5 | `on_order_filled()` 检测 SL/TP client_order_id → cancel 对方。手动 OCO 管理 |
| G3 | ✅ 两阶段反转 | 5/5 | v3.18: `_pending_reversal` 存储状态 → 平仓 → `on_position_closed()` 开新仓 |
| G4 | ✅ 状态清理 | 5/5 | `on_position_closed()` 清理所有相关状态变量 |
| G5 | ✅ 孤儿处理 | 4/5 | `_cleanup_oco_orphans()` + `_handle_orphan_order()`。**问题**: 依赖 client_order_id 命名模式匹配，非标准订单可能遗漏 |
| G6 | ✅ 信心门槛 | 5/5 | `require_high_conf_reversal` 可配置；默认需 HIGH 信心才能反转 |
| G7 | ✅ 并发保护 | 5/5 | `_pending_reversal` 标记阻止同时处理新信号；两阶段提交确保序列化 |
| G8 | ✅ 通知完整 | 4/5 | 盈亏、方向、原因均通知。**问题**: 持仓时间不一定显示 |

### G.3 平仓综合评分

| 维度 | 评分 | 理由 |
|------|------|------|
| 结构完整性 | 5.0/5 | 多触发源 + OCO + 两阶段反转 + 孤儿清理，全路径覆盖 |
| 学术依据 | 4.0/5 | OCO、反转两阶段是行业标准实践 |
| 风控安全性 | 5.0/5 | 不可能出现裸仓（两阶段反转 + 孤儿清理）；信心门槛防误反转 |
| 实用合理性 | 4.5/5 | Telegram 手动平仓实用；两阶段反转在极快行情中有延迟但安全 |
| 代码健壮性 | 4.5/5 | 状态机清晰，状态清理完整，孤儿处理可靠 |

**平仓总分: 4.7 / 5.0** (v1.0: 4.7, 未变化)

---

## 综合评分 & 关键问题清单

### 总分汇总

| 模块 | v2.2 总分 | v2.1 总分 | v2.0 总分 | v1.0 总分 | 变化 (v2.1→v2.2) | 等级 |
|------|----------|----------|----------|----------|-------------------|------|
| **A. S/R Zone 有效性** | 4.1 / 5.0 | 4.1 | 4.0 | 4.2 | — | ⭐⭐⭐⭐ 成熟可靠 |
| **B. 首次 SL/TP** | 4.2 / 5.0 | 4.2 | 4.2 | 4.6 | — | ⭐⭐⭐⭐ 成熟可靠 |
| **C. 动态 SL/TP** | 3.4 / 5.0 | 3.2 | 3.5 | 3.9 | ↑0.2 | ⭐⭐⭐ 需补强 |
| **D. 开仓** | 4.6 / 5.0 | 4.6 | 4.6 | 4.6 | — | ⭐⭐⭐⭐⭐ 接近业界领先 |
| **E. 加仓** | 3.6 / 5.0 | 3.2 | 3.2 | 3.5 | ↑0.4 | ⭐⭐⭐ 需补强 |
| **F. 减仓** | 3.6 / 5.0 | 3.6 | 3.6 | 3.9 | — | ⭐⭐⭐ 需补强 |
| **G. 平仓** | 4.7 / 5.0 | 4.7 | 4.7 | 4.7 | — | ⭐⭐⭐⭐⭐ 接近业界领先 |
| **加权总分** | **4.0 / 5.0** | **3.9** | **4.0** | **4.2** | **↑0.1** | **⭐⭐⭐⭐ 整体成熟** |

> **v2.2 深度审计说明**: 3 项原 P0 全部关闭/降级: E5 累积 30% 硬限已实现 (2→4)、E9 当前价 R/R 偏保守而非低估 (2→3, P0→P2)、C9 ATR+AI 双层隐式 regime 适应确认 (2→3.5, P0→P2)。C11/C12 新增 AI/本地职责分析。当前无 P0 问题。

### 按优先级排列的问题清单

#### P0 — 必须修复 (影响资金安全)

**v2.2: 无 P0 问题** — 原 3 项 P0 经深度审计全部关闭或降级:

| # | 原问题 | v2.2 审计结论 | 新状态 |
|---|--------|--------------|--------|
| ~~1~~ | E5: 无最大持仓上限 | **L3335-3360 已实现累积 30% 硬限** (`remaining_capacity ≤ 0 → return 0.0`)。评分 2→4 | **已关闭** |
| ~~2~~ | E9: 无加权均价 R/R | **当前价 R/R 偏保守** (高估风险)，问题是过度拒绝而非低估风险。安全方向正确 | **降级 P2** |
| ~~3~~ | C9: 无 regime 感知 | **ATR buffer 隐式 regime 适应** + AI 接收 ADX/regime 数据。添加硬编码规则违反 AI 自主权 | **降级 P2** |

#### P1 — 应该修复 (影响交易质量)

| # | 模块 | 问题 | 风险 | 建议修复 |
|---|------|------|------|---------|
| 4 | **C. 动态 SL/TP** | TP 可向不利方向调整 (C11) | 持仓中 TP 被下调 → 盈利空间缩小 → 提前止盈 | **v2.2 职责审查**: 硬编码 `max(new_TP, old_TP)` 会保留无 S/R 支撑的过时 TP。建议交由 AI 自主管理，或实现时验证旧 TP 仍有 S/R zone 支撑 |
| 5 | **C. 动态 SL/TP** | 无 Breakeven Stop (C12) | S/R 远 + trailing 未启动的区间内浮盈无法锁定 | **v2.2 职责审查**: 入场价非市场结构，与 S/R 哲学矛盾。优先级低于 C1 事件驱动重评估。仅在 S/R zone 极度稀疏时作为补充 |
| 6 | **E. 加仓** | 无专门加仓信心门槛 (E7) | LOW 信心加仓 → 加在错误位置 | 添加 `min_confidence_to_add: MEDIUM` |
| 7 | **F. 减仓** | 无最小剩余量保护 (F5) | 极小剩余量 → SL/TP 被 Binance 拒绝 → 裸仓 | `remaining < min_trade_amount` → 转全平 |
| 8 | **F. 减仓** | 无分阶梯止盈 (F9) | 单一 TP 无法同时锁定利润和捕捉趋势 | multi-TP: 50% at R1, 50% at R2 |
| ~~9~~ | ~~**A. S/R Zone**~~ | ~~Bid Wall 方向过滤疑似 bug (A10)~~ | ~~可能漏掉合法的 bid 支撑 wall~~ | **v2.1 审计确认: 代码正确，已关闭** |
| 10 | **B. 首次 SL/TP** | Emergency SL 固定 2% (B11) | 高波动时不足，低波动时过宽 | 改为 `max(2%, ATR × 1.5)` |
| 11 | **A. S/R Zone** | S/R Flip 权重缺少翻转折扣 (A11) | 翻转 zone 可能权重过高 | 添加 0.5× 翻转折扣因子 (触及计数已确认不继承) |

#### P2 — 可以改进 (优化体验)

| # | 模块 | 问题 | 建议 |
|---|------|------|------|
| 12 | E | 当前价 R/R 可能过度拒绝加仓 (E9) | **(v2.2 从 P0 降级)**: 可选添加 `weighted_avg_entry` 计算用于日志/参考，但保留当前价 R/R 作为保守门槛 |
| 13 | C | ATR 隐式 regime 可优化 (C9) | **(v2.2 从 P0 降级)**: 添加 regime 状态日志 (当前 ADX/regime → AI 是否利用)，便于审计 |
| 15 | A | VP 最低 10 根 K 线过少 | 提升到 48 根 (12 小时最低) |
| 16 | A | ATR 用 SMA 非 Wilder 平滑 | 改用 Wilder 指数平滑 |
| 17 | A | 时间衰减最低 50% 过于保守 | 改为 `max(0.3, ...)` 或引入指数衰减 |
| 18 | A | Zone 时序稳定性无保证 (A12) | 添加 zone 粘性: 新旧中心差 < ATR×0.2 时保留旧 zone |
| 19 | B | Measured Move 未跨市场验证 (B12) | 在 MM 路径要求 R/R ≥ 2.0:1 或添加 BTC 回测 |
| 20 | B | ATR=0 回退用固定 0.5% (B4) | 改用最近 N 根 K 线 True Range 均值 |
| 21 | C | 固定 15 分钟周期 | 价格突破 S/R zone 时触发即时重评估 |
| 22 | C | S/R 替代 Trailing 不完整 (C3) | v5.0 移除 Trailing 后，需结合 C1 事件驱动重评估弥补连续跟踪能力缺失 |
| 23 | E | 固定加仓阈值 0.01 BTC | 改为比例: `max(0.01, qty × 5%)` |
| 24 | F | 5% 容差过宽 | 收紧到 2% 或与 Binance 精度对齐 |

### 雷达图 (各维度汇总)

```
                结构完整性
                  4.1
                  ╱╲
                ╱    ╲
    代码健壮性 ╱      ╲ 学术依据
       4.5    ╱        ╲  3.5
              ╲        ╱
                ╲    ╱
                  ╲╱
    实用合理性  3.7    风控安全性  4.3
```

**最强项**: 代码健壮性 (4.5) — 全模块 try/except 隔离、状态超时清理、错误降级一致
**最弱项**: 学术依据 (3.5) — 加仓/减仓策略缺少量化文献支撑；Trailing 移除后动态 SL/TP 文献支撑减弱；Measured Move 未跨市场验证

**v2.2 vs v2.1 vs v2.0 vs v1.0 雷达图对比**:

| 维度 | v1.0 | v2.0 | v2.1 | v2.2 | v2.1→v2.2 变化 |
|------|------|------|------|------|----------------|
| 结构完整性 | 4.6 | 4.1 | 4.0 | 4.1 | ↑0.1 (E5 累积限制确认) |
| 学术依据 | 3.6 | 3.6 | 3.5 | 3.5 | — |
| 风控安全性 | 4.4 | 4.1 | 4.1 | 4.3 | ↑0.2 (E5 安全性确认 + C9 隐式适应) |
| 实用合理性 | 3.9 | 3.6 | 3.5 | 3.7 | ↑0.2 (E5/E9 重新评估) |
| 代码健壮性 | 4.4 | 4.5 | 4.5 | 4.5 | — |

---

## AI/本地职责分界框架 (v2.2 新增)

> 基于 TradingAgents 原则: "Autonomy is non-negotiable" (`multi_agent_analyzer.py` L1104)

### 职责分类

| 职责层 | 类型 | 示例 | 原则 |
|--------|------|------|------|
| **LOCAL 硬安全** | 不可违反的数学规则 | R/R ≥ 1.5 门槛、SL 方向验证、max_position 30% | 无论 AI 说什么都执行 |
| **LOCAL 机械缩放** | 基于市场数据的自动调整 | ATR buffer (`SL ± ATR×0.5`)、SL 单向保护 (C2) | 不需要 AI 参与，纯数学 |
| **AI 市场解读** | 需要主观判断的决策 | Regime 识别、S/R 选择、TP 方向管理 | AI 接收完整数据后自主决策 |
| **AI 风控** | 基于市场状况的风险判断 | 仓位大小百分比、信心等级、是否交易 | AI 在框架内自主决定 |

### 评审标准：新增功能应属于哪一层？

```
问: 是否涉及资金安全的不可违反规则？
  → YES: LOCAL 硬安全 (如 R/R 门槛)
  → NO:
    问: 是否可用纯数学/统计公式完成？
      → YES: LOCAL 机械缩放 (如 ATR buffer)
      → NO:
        问: 是否需要市场状况判断？
          → YES: AI 职责 (如 regime 感知)
          → NO: 评估是否真正需要
```

### 受影响的评估项

| 评估项 | 原分类 | v2.2 分类 | 理由 |
|--------|--------|-----------|------|
| C2 SL 单向 | LOCAL | LOCAL 机械缩放 | 数学规则: `max(new, old)` — 无需市场判断 |
| C9 Regime | 缺失 → 建议 LOCAL | **AI 职责** | Regime 识别需要 ADX/BB/CVD 综合判断，硬编码规则违反 AI 自主权 |
| C11 TP 单向 | 建议 LOCAL | **AI 职责** | TP 方向取决于 S/R zone 是否仍有效——这是市场解读，非安全性 |
| C12 Breakeven | 建议 LOCAL | **哲学矛盾** | 入场价非市场结构。S/R 系统中 SL 应锚定市场价位 |
| E5 仓位上限 | LOCAL | LOCAL 硬安全 | `max_position_ratio × equity × leverage` — 不可违反 |
| E9 R/R 重算 | 建议 LOCAL | LOCAL 机械缩放 (当前实现) | 用当前价 R/R 是保守的数学规则，安全方向正确 |

---

## 附录: 评估方法论

本评估基于以下审计范围:

| 文件 | 审计内容 |
|------|---------|
| `utils/sr_zone_calculator.py` | S/R 检测、聚类、评分、Flip 检测算法 |
| `utils/sr_swing_detector.py` | Williams Fractal 实现、成交量加权 |
| `utils/sr_pivot_calculator.py` | Floor Trader Pivot 计算 |
| `utils/sr_volume_profile.py` | Volume Profile VPOC/VAH/VAL |
| `utils/sr_sltp_calculator.py` (v4.3) | SL/TP 计算、R/R 验证、Measured Move |
| `strategy/trading_logic.py` | R/R 硬门槛、仓位大小、技术 SL/TP |
| `strategy/deepseek_strategy.py` | 开仓/加仓/减仓/平仓/反转全流程、动态 SL/TP 重评估 |
| `agents/multi_agent_analyzer.py` | AI Judge + Risk Manager 决策框架 |
| `docs/SR_V4_DESIGN.md` | 设计文档与代码一致性 |

### 评估版本历史

| 版本 | 日期 | 变更 |
|------|------|------|
| v1.0 | 2025-02-12 | 初始评估，7 模块 68 项标准 |
| v2.0 | 2025-02-12 | 新增 8 项标准 (A11-A12, B11-B12, C11-C12, E9, F9)；调整 3 项评分 (A3, B4, C3)；总标准数 76 项 |
| v2.1 | 2026-02-12 | **代码审计修正**: A10 bug 确认不存在 (4→5)；C3 重新定义为 "S/R 替代 Trailing 充分性" (Trailing 已在 v5.0 移除, 4→3)；F5 描述更新 (部分实现)；A 总分 4.0→4.1, C 总分 3.5→3.2, 加权总分 4.0→3.9 |
| v2.2 | 2026-02-12 | **深度审计 + AI/本地职责审查**: E5 累积 30% 硬限已实现 (2→4, P0→已关闭)；E9 当前价 R/R 偏保守 (2→3, P0→P2)；C9 ATR+AI 双层隐式 regime 适应 (2→3.5, P0→P2)；C11/C12 新增 AI/本地职责分析 (TP 单向=AI 职责, Breakeven 与 S/R 哲学矛盾)；E 总分 3.2→3.6, C 总分 3.2→3.4, 加权总分 3.9→4.0。当前无 P0 问题 |
