# GitHub Actions å·¥ä½œæµ: æ™ºèƒ½æäº¤åˆ†æ
#
# è§¦å‘æ—¶æœº:
# 1. æ¯æ¬¡ push åˆ° main åˆ†æ”¯
# 2. æ¯æ¬¡ PR åˆ›å»º/æ›´æ–°
# 3. æ‰‹åŠ¨è§¦å‘
#
# åŠŸèƒ½:
# 1. smart_commit_analyzer.py - è‡ªåŠ¨æ¼”è¿›çš„å›å½’æ£€æµ‹ (è§„åˆ™è‡ªåŠ¨ä» git ç”Ÿæˆ)
# 2. analyze_commits_ai.py - AI æ·±åº¦è¯­ä¹‰åˆ†æ (å¯é€‰ï¼Œéœ€è¦ DEEPSEEK_API_KEY)
# 3. analyze_dependencies.py - Python AST ä¾èµ–åˆ†æ (å¾ªç¯ä¾èµ–ã€ç¼ºå¤±æ¨¡å—æ£€æµ‹)
#
# ç›¸å…³å·¥ä½œæµ:
# - codeql-analysis.yml - CodeQL å®‰å…¨å’Œä»£ç è´¨é‡åˆ†æ (æ›´æ·±å…¥çš„è¯­ä¹‰åˆ†æ)

name: Commit Analysis

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      commits_to_analyze:
        description: 'åˆ†ææäº¤æ•°é‡'
        required: false
        default: '100'
        type: string

jobs:
  # =========================================================================
  # Job 1: æ™ºèƒ½å›å½’æ£€æµ‹ (è‡ªåŠ¨æ¼”è¿›ï¼Œè§„åˆ™ä» git å†å²è‡ªåŠ¨ç”Ÿæˆ)
  # =========================================================================
  smart-analysis:
    name: Smart Regression Detection
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run smart_commit_analyzer.py
        id: analyze
        run: |
          python3 scripts/smart_commit_analyzer.py \
            --commits ${{ github.event.inputs.commits_to_analyze || '100' }} \
            --json > smart_analysis.json 2>&1 || true

          # æå–ç»“æœ
          TOTAL=$(python3 -c "import json; d=json.load(open('smart_analysis.json')); print(d.get('update', {}).get('total_rules', 0))")
          PASSED=$(python3 -c "import json; d=json.load(open('smart_analysis.json')); print(d.get('validation', {}).get('passed', 0))")
          FAILED=$(python3 -c "import json; d=json.load(open('smart_analysis.json')); print(d.get('validation', {}).get('failed', 0))")
          WARNINGS=$(python3 -c "import json; d=json.load(open('smart_analysis.json')); print(d.get('validation', {}).get('warnings', 0))")

          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "warnings=$WARNINGS" >> $GITHUB_OUTPUT

          # æ˜¾ç¤ºç»“æœæ‘˜è¦
          echo "ğŸ“Š è§„åˆ™æ€»æ•°: $TOTAL"
          echo "âœ… é€šè¿‡: $PASSED"
          echo "âŒ å¤±è´¥: $FAILED"
          echo "âš ï¸ è­¦å‘Š: $WARNINGS"

      - name: Generate summary
        run: |
          echo "## ğŸ” Smart Regression Detection" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“‹ Total Rules | ${{ steps.analyze.outputs.total }} |" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… Passed | ${{ steps.analyze.outputs.passed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| âŒ Failed | ${{ steps.analyze.outputs.failed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| âš ï¸ Warnings | ${{ steps.analyze.outputs.warnings }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # æ˜¾ç¤ºå¤±è´¥è¯¦æƒ…
          python3 -c "
          import json
          try:
              data = json.load(open('smart_analysis.json'))
              failed = data.get('failed_details', [])
              if failed:
                  print('### âŒ Failed Checks')
                  print()
                  for f in failed[:10]:
                      print(f\"- **{f.get('file', 'unknown')}** (commit {f.get('commit', '?')})\")
                      print(f\"  - {f.get('message', 'No details')}\")
          except Exception as e:
              print(f'Error: {e}')
          " >> $GITHUB_STEP_SUMMARY

      - name: Upload analysis results
        uses: actions/upload-artifact@v6
        with:
          name: smart-analysis-results
          path: |
            smart_analysis.json
            configs/auto_generated_rules.json

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const total = '${{ steps.analyze.outputs.total }}';
            const passed = '${{ steps.analyze.outputs.passed }}';
            const failed = '${{ steps.analyze.outputs.failed }}';
            const warnings = '${{ steps.analyze.outputs.warnings }}';

            let status = failed > 0 ? 'âš ï¸' : 'âœ…';
            let body = `## ${status} Smart Regression Detection\n\n`;
            body += `**Auto-generated rules from git history**\n\n`;
            body += `| Metric | Count |\n|--------|-------|\n`;
            body += `| ğŸ“‹ Total Rules | ${total} |\n`;
            body += `| âœ… Passed | ${passed} |\n`;
            body += `| âŒ Failed | ${failed} |\n`;
            body += `| âš ï¸ Warnings | ${warnings} |\n`;

            if (failed > 0) {
              body += `\nâš ï¸ **Potential Regressions Detected**: Please review the failed checks in the workflow summary.`;
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  # =========================================================================
  # Job 2: AI æ·±åº¦åˆ†æ (å¯é€‰ï¼Œéœ€è¦ DEEPSEEK_API_KEY)
  # =========================================================================
  ai-analysis:
    name: AI Deep Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Check API Key
        id: check_key
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          if [ -z "$DEEPSEEK_API_KEY" ]; then
            echo "âš ï¸ DEEPSEEK_API_KEY not configured"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… DEEPSEEK_API_KEY available"
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout code
        if: steps.check_key.outputs.skip != 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        if: steps.check_key.outputs.skip != 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        if: steps.check_key.outputs.skip != 'true'
        run: pip install openai

      - name: Run AI analysis
        if: steps.check_key.outputs.skip != 'true'
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          python3 scripts/analyze_commits_ai.py --commits 10 --json > ai_analysis.json 2>&1 || true

      - name: Generate AI summary
        if: steps.check_key.outputs.skip != 'true'
        run: |
          echo "## ğŸ¤– AI Deep Analysis" >> $GITHUB_STEP_SUMMARY
          python3 -c "
          import json
          try:
              data = json.load(open('ai_analysis.json'))
              commits = data.get('commits', [])
              print(f'Analyzed {len(commits)} commits with DeepSeek AI')
              print()
              for c in commits[:5]:
                  print(f\"- **{c.get('hash', '')[:7]}**: {c.get('summary', 'No summary')[:80]}\")
          except Exception as e:
              print(f'Error: {e}')
          " >> $GITHUB_STEP_SUMMARY

      - name: Upload AI results
        if: steps.check_key.outputs.skip != 'true'
        uses: actions/upload-artifact@v6
        with:
          name: ai-analysis-results
          path: ai_analysis.json

      - name: Create skip marker
        if: steps.check_key.outputs.skip == 'true'
        run: |
          echo "## ğŸ¤– AI Deep Analysis" >> $GITHUB_STEP_SUMMARY
          echo "â­ï¸ Skipped (DEEPSEEK_API_KEY not configured)" >> $GITHUB_STEP_SUMMARY

  # =========================================================================
  # Job 3: ä¾èµ–åˆ†æ (Python AST-based)
  # =========================================================================
  dependency-analysis:
    name: Dependency Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run dependency analysis
        id: deps
        run: |
          python3 scripts/analyze_dependencies.py --json > dependency_analysis.json 2>&1 || true

          # æå–ç»“æœ
          TOTAL_FILES=$(python3 -c "import json; d=json.load(open('dependency_analysis.json')); print(d.get('summary', {}).get('total_files', 0))")
          TOTAL_IMPORTS=$(python3 -c "import json; d=json.load(open('dependency_analysis.json')); print(d.get('summary', {}).get('total_imports', 0))")
          INTERNAL_DEPS=$(python3 -c "import json; d=json.load(open('dependency_analysis.json')); print(d.get('summary', {}).get('internal_dependencies', 0))")
          CIRCULAR=$(python3 -c "import json; d=json.load(open('dependency_analysis.json')); print(d.get('summary', {}).get('circular_dependencies', 0))")
          MISSING=$(python3 -c "import json; d=json.load(open('dependency_analysis.json')); print(d.get('summary', {}).get('missing_modules', 0))")

          echo "total_files=$TOTAL_FILES" >> $GITHUB_OUTPUT
          echo "total_imports=$TOTAL_IMPORTS" >> $GITHUB_OUTPUT
          echo "internal_deps=$INTERNAL_DEPS" >> $GITHUB_OUTPUT
          echo "circular=$CIRCULAR" >> $GITHUB_OUTPUT
          echo "missing=$MISSING" >> $GITHUB_OUTPUT

          # æ˜¾ç¤ºç»“æœæ‘˜è¦
          echo "ğŸ“ æ‰«ææ–‡ä»¶: $TOTAL_FILES"
          echo "ğŸ“¦ æ€» import æ•°: $TOTAL_IMPORTS"
          echo "ğŸ”— å†…éƒ¨ä¾èµ–: $INTERNAL_DEPS"
          echo "ğŸ”„ å¾ªç¯ä¾èµ–: $CIRCULAR"
          echo "âŒ ç¼ºå¤±æ¨¡å—: $MISSING"

      - name: Generate dependency summary
        run: |
          echo "## ğŸ“¦ Dependency Analysis" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“ Total Files | ${{ steps.deps.outputs.total_files }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“¦ Total Imports | ${{ steps.deps.outputs.total_imports }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”— Internal Dependencies | ${{ steps.deps.outputs.internal_deps }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”„ Circular Dependencies | ${{ steps.deps.outputs.circular }} |" >> $GITHUB_STEP_SUMMARY
          echo "| âŒ Missing Modules | ${{ steps.deps.outputs.missing }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # æ˜¾ç¤ºé—®é¢˜è¯¦æƒ…
          python3 -c "
          import json
          try:
              data = json.load(open('dependency_analysis.json'))
              issues = data.get('issues', {})

              circular = issues.get('circular_dependencies', [])
              if circular:
                  print('### ğŸ”„ Circular Dependencies')
                  print()
                  for i, cycle in enumerate(circular[:5], 1):
                      print(f'{i}. ' + ' â†’ '.join(cycle))
                  print()

              missing = issues.get('missing_modules', [])
              if missing:
                  print('### âŒ Missing Modules')
                  print()
                  for m in missing[:10]:
                      print(f\"- \`{m['file']}:{m['line']}\` - from {m['module']} import {m['import_name']}\")
                  print()

              if not circular and not missing:
                  print('âœ… No dependency issues detected!')
          except Exception as e:
              print(f'Error: {e}')
          " >> $GITHUB_STEP_SUMMARY

      - name: Upload dependency analysis
        uses: actions/upload-artifact@v6
        with:
          name: dependency-analysis-results
          path: dependency_analysis.json

      - name: Fail on critical issues
        if: steps.deps.outputs.circular != '0' || steps.deps.outputs.missing != '0'
        run: |
          echo "âš ï¸ Dependency issues detected!"
          echo "  - Circular dependencies: ${{ steps.deps.outputs.circular }}"
          echo "  - Missing modules: ${{ steps.deps.outputs.missing }}"
          echo ""
          echo "Run 'python3 scripts/analyze_dependencies.py' locally for details."
          # ä¸é˜»æ­¢æ„å»ºï¼Œåªæ˜¯è­¦å‘Š
          # exit 1
