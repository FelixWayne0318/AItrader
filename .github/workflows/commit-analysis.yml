# GitHub Actions å·¥ä½œæµ: è‡ªåŠ¨æäº¤åˆ†æž
#
# è§¦å‘æ—¶æœº:
# 1. æ¯æ¬¡ push åˆ° main åˆ†æ”¯
# 2. æ¯æ¬¡ PR åˆ›å»º/æ›´æ–°
# 3. æ‰‹åŠ¨è§¦å‘
#
# åŠŸèƒ½:
# 1. è¿è¡Œ validate_commit_fixes.py æ£€æŸ¥å·²çŸ¥ä¿®å¤
# 2. è¿è¡Œ analyze_git_changes.py åˆ†æžæäº¤
# 3. (å¯é€‰) è¿è¡Œ analyze_commits_ai.py AI åˆ†æž
# 4. ç»“æžœä¿å­˜ä¸º Artifact å¹¶è¯„è®ºåˆ° PR

name: Commit Analysis

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      ai_analysis:
        description: 'å¯ç”¨ AI æ·±åº¦åˆ†æž (éœ€è¦ API key)'
        required: false
        default: 'false'
        type: boolean
      commits_to_analyze:
        description: 'åˆ†æžæäº¤æ•°é‡'
        required: false
        default: '20'
        type: string

jobs:
  # =========================================================================
  # Job 1: åŸºç¡€éªŒè¯ (å¿«é€Ÿï¼Œæ¯æ¬¡éƒ½è¿è¡Œ)
  # =========================================================================
  validate-fixes:
    name: Validate Known Fixes
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²ç”¨äºŽåˆ†æž

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pyyaml python-dotenv

      - name: Run validate_commit_fixes.py
        id: validate
        run: |
          python3 validate_commit_fixes.py --json > validation_result.json 2>&1 || true

          # æå–ç»“æžœ
          PASSED=$(python3 -c "import json; d=json.load(open('validation_result.json')); print(len(d.get('passed', [])))")
          FAILED=$(python3 -c "import json; d=json.load(open('validation_result.json')); print(len(d.get('failed', [])))")
          WARNINGS=$(python3 -c "import json; d=json.load(open('validation_result.json')); print(len(d.get('warnings', [])))")

          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "warnings=$WARNINGS" >> $GITHUB_OUTPUT

          # å¦‚æžœæœ‰å¤±è´¥ï¼Œè®¾ç½®ä¸ºå¤±è´¥çŠ¶æ€
          if [ "$FAILED" -gt 0 ]; then
            echo "âŒ $FAILED validation(s) failed!"
            exit 1
          fi

      - name: Upload validation results
        uses: actions/upload-artifact@v4
        with:
          name: validation-results
          path: validation_result.json

      - name: Comment on PR (if PR)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const passed = '${{ steps.validate.outputs.passed }}';
            const failed = '${{ steps.validate.outputs.failed }}';
            const warnings = '${{ steps.validate.outputs.warnings }}';

            let status = failed > 0 ? 'âŒ' : 'âœ…';
            let body = `## ${status} Commit Fix Validation Results\n\n`;
            body += `| Metric | Count |\n|--------|-------|\n`;
            body += `| âœ… Passed | ${passed} |\n`;
            body += `| âŒ Failed | ${failed} |\n`;
            body += `| âš ï¸ Warnings | ${warnings} |\n`;

            if (failed > 0) {
              body += `\n**Action Required**: Please fix the failed validations before merging.`;
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  # =========================================================================
  # Job 2: Git åŽ†å²åˆ†æž (ä¸­ç­‰é€Ÿåº¦)
  # =========================================================================
  analyze-changes:
    name: Analyze Git Changes
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pyyaml python-dotenv

      - name: Run analyze_git_changes.py
        run: |
          python3 analyze_git_changes.py \
            --commits ${{ github.event.inputs.commits_to_analyze || '20' }} \
            --json > git_analysis.json 2>&1 || true

      - name: Generate summary
        run: |
          python3 -c "
          import json
          try:
              data = json.load(open('git_analysis.json'))
              print('## Git History Analysis')
              print()
              print(f\"Total commits analyzed: {data.get('total_commits', 0)}\")
              print()
              print('### By Type')
              for t, c in data.get('by_type', {}).items():
                  print(f'- {t}: {c}')
              print()
              print('### Fix Commits')
              for fix in data.get('fix_commits', [])[:5]:
                  print(f\"- {fix['hash']}: {fix['message'][:60]}\")
          except Exception as e:
              print(f'Error: {e}')
          " >> $GITHUB_STEP_SUMMARY

      - name: Upload analysis results
        uses: actions/upload-artifact@v4
        with:
          name: git-analysis-results
          path: git_analysis.json

  # =========================================================================
  # Job 3: AI æ·±åº¦åˆ†æž (å¯é€‰ï¼Œéœ€è¦ API key)
  # =========================================================================
  ai-analysis:
    name: AI Deep Analysis
    runs-on: ubuntu-latest
    if: github.event.inputs.ai_analysis == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pyyaml python-dotenv openai

      - name: Run AI analysis
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          if [ -z "$DEEPSEEK_API_KEY" ]; then
            echo "âŒ DEEPSEEK_API_KEY not set"
            exit 1
          fi

          python3 analyze_commits_ai.py \
            --commits 10 \
            --json > ai_analysis.json 2>&1 || true

      - name: Upload AI analysis results
        uses: actions/upload-artifact@v4
        with:
          name: ai-analysis-results
          path: ai_analysis.json

  # =========================================================================
  # Job 4: æ±‡æ€»æŠ¥å‘Š
  # =========================================================================
  summary:
    name: Generate Summary Report
    runs-on: ubuntu-latest
    needs: [validate-fixes, analyze-changes]
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: results

      - name: Generate combined report
        run: |
          echo "# ðŸ“Š Commit Analysis Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Generated at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Validation results
          if [ -f results/validation-results/validation_result.json ]; then
            echo "## âœ… Validation Results" >> $GITHUB_STEP_SUMMARY
            python3 -c "
          import json
          data = json.load(open('results/validation-results/validation_result.json'))
          print(f\"- Passed: {len(data.get('passed', []))}\")
          print(f\"- Failed: {len(data.get('failed', []))}\")
          print(f\"- Warnings: {len(data.get('warnings', []))}\")
          " >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "View detailed results in the Artifacts section." >> $GITHUB_STEP_SUMMARY
